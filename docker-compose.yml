services:
  # ── Tor daemon ──────────────────────────────────────────────────────────────
  tor:
    build:
      context: ./docker/tor
    restart: unless-stopped
    volumes:
      - tor_data:/var/lib/tor
    networks:
      - scanner_net
    healthcheck:
      test: ["CMD", "curl", "--socks5", "localhost:9050", "-s", "https://check.torproject.org/api/ip"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 20s

  # ── Scanner / crawler ───────────────────────────────────────────────────────
  scanner:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
    restart: "no"
    depends_on:
      tor:
        condition: service_healthy
    env_file:
      - .env
    volumes:
      - ./config:/app/config:ro
      - app_data:/app/data
    networks:
      - scanner_net
    command: ["python", "-m", "darkweb_scanner.main", "scan"]
    profiles:
      - scan

  # ── Dashboard ───────────────────────────────────────────────────────────────
  dashboard:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
    restart: unless-stopped
    depends_on:
      - tor
    env_file:
      - .env
    volumes:
      - ./config:/app/config:ro
      - app_data:/app/data
    expose:
      - "8080"
    networks:
      - scanner_net
    command: ["python", "-m", "darkweb_scanner.dashboard.app"]

  # ── Nginx SSL reverse proxy ─────────────────────────────────────────────────
  nginx:
    build:
      context: ./docker/nginx
    restart: unless-stopped
    depends_on:
      - dashboard
    environment:
      - DOMAIN=${DOMAIN:-}
      - SSL_EMAIL=${SSL_EMAIL:-}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - nginx_certs:/etc/nginx/certs
      - letsencrypt:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
    networks:
      - scanner_net

volumes:
  tor_data:
  app_data:
  nginx_certs:
  letsencrypt:
  certbot_webroot:

networks:
  scanner_net:
    driver: bridge
