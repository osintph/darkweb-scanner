services:
  # ── Tor daemon ──────────────────────────────────────────────────────────────
  tor:
    build:
      context: ./docker/tor
    restart: unless-stopped
    volumes:
      - tor_data:/var/lib/tor
    networks:
      - scanner_net
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "9050"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ── Scanner / crawler ───────────────────────────────────────────────────────
  scanner:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
    restart: "no"
    depends_on:
      tor:
        condition: service_healthy
    env_file:
      - .env
    volumes:
      - ./config:/app/config:ro
      - app_data:/app/data
    networks:
      - scanner_net
    command: ["python", "-m", "darkweb_scanner.main", "scan"]
    profiles:
      - scan

  # ── Dashboard ───────────────────────────────────────────────────────────────
  dashboard:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
    restart: unless-stopped
    depends_on:
      - tor
    env_file:
      - .env
    volumes:
      - ./config:/app/config:ro
      - app_data:/app/data
    expose:
      - "8080"
    networks:
      - scanner_net
    command: ["python", "-m", "darkweb_scanner.dashboard.app"]

  # ── Nginx SSL reverse proxy ─────────────────────────────────────────────────
  nginx:
    build:
      context: ./docker/nginx
    restart: unless-stopped
    depends_on:
      - dashboard
    environment:
      - DOMAIN=${DOMAIN:-}
      - SSL_EMAIL=${SSL_EMAIL:-}
      - WWW_DOMAIN=${WWW_DOMAIN:-}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - nginx_certs:/etc/nginx/certs
      - letsencrypt:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
      - ./www:/var/www/osintph-www:ro
    networks:
      - scanner_net

  # ── Web Check ───────────────────────────────────────────────────────────────
  webcheck:
    build:
      context: /root/web-check
    restart: unless-stopped
    environment:
      - PORT=3000
      - DISABLE_GUI=false
    expose:
      - "3000"
    networks:
      - scanner_net

volumes:
  tor_data:
  app_data:
  nginx_certs:
  letsencrypt:
  certbot_webroot:

networks:
  scanner_net:
    driver: bridge
