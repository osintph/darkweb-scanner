<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dark Web Scanner â€” Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0d1117; --surface: #161b22; --surface2: #21262d;
      --border: #30363d; --text: #e6edf3; --muted: #8b949e;
      --accent: #58a6ff; --red: #f85149; --green: #3fb950;
      --yellow: #d29922; --purple: #bc8cff;
      --font: 'Segoe UI', system-ui, sans-serif;
      --mono: 'Cascadia Code', 'Fira Code', monospace;
    }
    body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; }

    /* â”€â”€ Nav â”€â”€ */
    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 32px; display: flex; align-items: center; gap: 0; position: sticky; top: 0; z-index: 100;
    }
    .logo { display: flex; align-items: center; gap: 10px; padding: 16px 0; margin-right: 24px; }
    .logo h1 { font-size: 1rem; font-weight: 700; white-space: nowrap; }
    .logo .badge { background: var(--red); color: white; font-size: 0.65rem; padding: 2px 7px; border-radius: 20px; font-weight: 700; letter-spacing: 0.05em; }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; flex-shrink: 0; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }
    nav { display: flex; gap: 2px; flex: 1; }
    .nav-tab {
      padding: 18px 16px; font-size: 0.85rem; font-weight: 500; color: var(--muted);
      cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s;
      white-space: nowrap; background: none; border-top: none; border-left: none; border-right: none;
      font-family: var(--font);
    }
    .nav-tab:hover { color: var(--text); }
    .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .nav-tab.admin-only { display: none; }
    .nav-tab.admin-only.visible { display: block; }
    .header-right { margin-left: auto; display: flex; align-items: center; gap: 12px; padding-left: 24px; }
    .crawl-btn {
      background: var(--green); color: #0d1117; border: none; border-radius: 6px;
      padding: 7px 14px; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: opacity 0.15s;
    }
    .crawl-btn:hover { opacity: 0.85; }
    .crawl-btn.running { background: var(--red); }
    .user-pill { color: var(--muted); font-size: 0.82rem; }
    .logout-link { color: var(--muted); font-size: 0.8rem; text-decoration: none; }
    .logout-link:hover { color: var(--red); }

    /* â”€â”€ Layout â”€â”€ */
    main { padding: 32px; max-width: 1400px; margin: 0 auto; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Cards / Panels â”€â”€ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
    .stat-card .label { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 8px; }
    .stat-card .value { font-size: 2rem; font-weight: 700; color: var(--accent); }
    .stat-card .sub { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 24px; overflow: hidden; }
    .panel-header { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .panel-header h2 { font-size: 0.9rem; font-weight: 600; }
    .panel-body { padding: 20px; }

    /* â”€â”€ Tables â”€â”€ */
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { text-align: left; padding: 10px 14px; color: var(--muted); font-weight: 500; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
    td { padding: 12px 14px; border-bottom: 1px solid var(--border); vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface2); }
    .keyword-tag { display: inline-block; background: rgba(88,166,255,.15); color: var(--accent); border: 1px solid rgba(88,166,255,.3); border-radius: 4px; padding: 2px 8px; font-size: 0.78rem; font-weight: 600; font-family: var(--mono); }
    .cat-tag { display: inline-block; background: rgba(188,140,255,.12); color: var(--purple); border: 1px solid rgba(188,140,255,.25); border-radius: 4px; padding: 2px 8px; font-size: 0.75rem; }
    .url-cell { font-family: var(--mono); font-size: 0.78rem; color: var(--accent); word-break: break-all; max-width: 260px; }
    .ctx-cell { color: var(--muted); font-size: 0.78rem; font-family: var(--mono); max-width: 380px; white-space: pre-wrap; word-break: break-word; }
    .time-cell { color: var(--muted); font-size: 0.75rem; white-space: nowrap; }

    /* â”€â”€ Forms / Inputs â”€â”€ */
    .form-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 0.8rem; color: var(--muted); }
    input[type="text"], input[type="email"], input[type="password"], select {
      background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); padding: 8px 12px; font-size: 0.85rem; font-family: var(--font);
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    input[type="text"].wide { width: 280px; }
    .btn { border: none; border-radius: 6px; padding: 8px 16px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: opacity .15s; font-family: var(--font); }
    .btn-primary { background: var(--accent); color: #0d1117; }
    .btn-primary:hover { opacity: .85; }
    .btn-danger { background: rgba(248,81,73,.15); color: var(--red); border: 1px solid rgba(248,81,73,.3); }
    .btn-danger:hover { background: rgba(248,81,73,.25); }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--accent); }

    /* â”€â”€ Crawl status bar â”€â”€ */
    .crawl-status {
      background: rgba(63,185,80,.08); border: 1px solid rgba(63,185,80,.25);
      border-radius: 8px; padding: 12px 20px; margin-bottom: 24px;
      display: flex; align-items: center; gap: 16px; font-size: 0.85rem;
    }
    .crawl-status.idle { background: var(--surface); border-color: var(--border); }
    .crawl-status .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 1s infinite; }
    .crawl-status.idle .dot { background: var(--muted); animation: none; }

    /* â”€â”€ Empty state â”€â”€ */
    .empty { padding: 60px; text-align: center; color: var(--muted); }
    .empty .icon { font-size: 2.5rem; margin-bottom: 12px; }
    .empty p { font-size: 0.875rem; }

    /* â”€â”€ User badges â”€â”€ */
    .badge-admin { background: rgba(248,81,73,.15); color: var(--red); border: 1px solid rgba(248,81,73,.3); border-radius: 4px; padding: 2px 7px; font-size: 0.72rem; font-weight: 600; }
    .badge-user { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); border-radius: 4px; padding: 2px 7px; font-size: 0.72rem; }
    .badge-2fa { background: rgba(63,185,80,.12); color: var(--green); border: 1px solid rgba(63,185,80,.3); border-radius: 4px; padding: 2px 7px; font-size: 0.72rem; }

    /* â”€â”€ Toast â”€â”€ */
    #toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px 20px; font-size: 0.85rem; opacity: 0; transform: translateY(8px); transition: all .25s; pointer-events: none; z-index: 999; }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.success { border-color: var(--green); color: var(--green); }
    #toast.error { border-color: var(--red); color: var(--red); }

    /* â”€â”€ Settings sections â”€â”€ */
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; }
    .section-title { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); margin-bottom: 16px; }
    .kw-pills { display: flex; flex-wrap: wrap; gap: 8px; }
    .kw-pill { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; }
    .kw-pill .count { background: var(--accent); color: #0d1117; border-radius: 10px; padding: 1px 7px; font-size: 0.7rem; font-weight: 700; }
    .kw-pill:hover { border-color: var(--accent); color: var(--accent); cursor: pointer; }
    .seed-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-family: var(--mono); font-size: 0.8rem; color: var(--accent); }
    .seed-item:last-child { border-bottom: none; }
    .tag-green { color: var(--green); }
    .tag-red { color: var(--red); }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="status-dot" id="statusDot"></div>
    <h1>Dark Web Scanner</h1>
    <span class="badge">THREAT INTEL</span>
  </div>
  <nav>
    <button class="nav-tab active" onclick="switchTab('hits', this)">ğŸ“Š Dashboard</button>
    <button class="nav-tab" onclick="switchTab('keywords', this)">ğŸ”‘ Keywords</button>
    <button class="nav-tab" onclick="switchTab('seeds', this)">ğŸŒ± Seeds</button>
    <button class="nav-tab admin-only" id="tab-users" onclick="switchTab('users', this)">ğŸ‘¥ Users</button>
    <button class="nav-tab" onclick="switchTab('settings', this)">âš™ï¸ Settings</button>
  </nav>
  <div class="header-right">
    <button class="crawl-btn" id="crawlBtn" onclick="toggleCrawl()">â–¶ Start Crawl</button>
    <span class="user-pill">{{ username }}</span>
    <a href="/logout" class="logout-link">Sign out</a>
  </div>
</header>

<main>

  <!-- â”€â”€ Dashboard Tab â”€â”€ -->
  <div class="tab-panel active" id="panel-hits">
    <div id="crawlStatusBar" class="crawl-status idle">
      <div class="dot"></div>
      <span id="crawlStatusText">No active crawl</span>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="label">Crawl Sessions</div><div class="value" id="statSessions">â€”</div></div>
      <div class="stat-card"><div class="label">Pages Crawled</div><div class="value" id="statPages">â€”</div></div>
      <div class="stat-card"><div class="label">Keyword Hits</div><div class="value" id="statHits">â€”</div></div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2>Top Keywords</h2>
      </div>
      <div class="kw-pills" style="padding:16px 20px" id="topKeywords">
        <span style="color:var(--muted);font-size:.85rem">Loading...</span>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2>Keyword Hits</h2>
        <button class="btn btn-secondary" onclick="loadHits()">â†» Refresh</button>
      </div>
      <div style="padding:14px 20px;border-bottom:1px solid var(--border);display:flex;gap:10px;flex-wrap:wrap">
        <input type="text" id="keywordFilter" class="wide" placeholder="Filter by keywordâ€¦"/>
        <button class="btn btn-primary" onclick="applyFilter()">Search</button>
        <button class="btn btn-secondary" onclick="clearFilter()">Clear</button>
      </div>
      <div id="hitsContainer"><div class="empty"><div class="icon">ğŸ”</div><p>Loadingâ€¦</p></div></div>
    </div>
  </div>

  <!-- â”€â”€ Keywords Tab â”€â”€ -->
  <div class="tab-panel" id="panel-keywords">
    <div class="panel">
      <div class="panel-header"><h2>Manage Keywords</h2></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group">
            <label>Keyword</label>
            <input type="text" id="newKeyword" class="wide" placeholder="e.g. credential dump"/>
          </div>
          <div class="form-group">
            <label>Category</label>
            <select id="newCategory" style="width:180px">
              <option value="custom">custom</option>
              <option value="threat_intel">threat_intel</option>
              <option value="brand_monitoring">brand_monitoring</option>
              <option value="infrastructure">infrastructure</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addKeyword()">+ Add Keyword</button>
        </div>
        <div id="keywordsList"><div class="empty"><div class="icon">ğŸ”‘</div><p>Loading keywordsâ€¦</p></div></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Seeds Tab â”€â”€ -->
  <div class="tab-panel" id="panel-seeds">
    <div class="panel">
      <div class="panel-header"><h2>Seed URLs</h2><span style="color:var(--muted);font-size:.8rem">.onion URLs to start crawling from</span></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group">
            <label>Add Seed URL</label>
            <input type="text" id="newSeed" style="width:420px" placeholder="http://example.onion"/>
          </div>
          <button class="btn btn-primary" onclick="addSeed()">+ Add Seed</button>
        </div>
        <div id="seedsList"><div class="empty"><div class="icon">ğŸŒ±</div><p>Loading seedsâ€¦</p></div></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Users Tab (admin only) â”€â”€ -->
  <div class="tab-panel" id="panel-users">
    <div class="panel">
      <div class="panel-header"><h2>User Management</h2></div>
      <div class="panel-body">
        <p style="color:var(--muted);font-size:.83rem;margin-bottom:20px">New users can log in immediately. Encourage them to set up 2FA from their Settings page.</p>
        <div class="form-row" style="background:var(--surface2);padding:16px;border-radius:8px;border:1px solid var(--border)">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="newUsername" placeholder="username"/>
          </div>
          <div class="form-group">
            <label>Email (optional)</label>
            <input type="email" id="newEmail" placeholder="user@example.com"/>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="newUserPassword" placeholder="Min 10 chars, 1 upper, 1 number"/>
          </div>
          <div class="form-group">
            <label>Role</label>
            <select id="newUserRole" style="width:120px">
              <option value="0">User</option>
              <option value="1">Admin</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="createUser()">+ Create User</button>
        </div>
        <div id="usersList" style="margin-top:20px"><div class="empty"><div class="icon">ğŸ‘¥</div><p>Loading usersâ€¦</p></div></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Settings Tab â”€â”€ -->
  <div class="tab-panel" id="panel-settings">
    <div class="settings-grid">

      <div class="panel">
        <div class="panel-header"><h2>Change Password</h2></div>
        <div class="panel-body">
          <div class="form-group" style="margin-bottom:12px">
            <label>Current Password</label>
            <input type="password" id="currentPw" style="width:100%"/>
          </div>
          <div class="form-group" style="margin-bottom:12px">
            <label>New Password</label>
            <input type="password" id="newPw" style="width:100%"/>
          </div>
          <div class="form-group" style="margin-bottom:16px">
            <label>Confirm New Password</label>
            <input type="password" id="confirmPw" style="width:100%"/>
          </div>
          <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header"><h2>Two-Factor Authentication</h2></div>
        <div class="panel-body">
          <div id="totpStatus"><p style="color:var(--muted);font-size:.85rem">Loadingâ€¦</p></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header"><h2>Account Info</h2></div>
        <div class="panel-body" id="profileInfo">
          <p style="color:var(--muted);font-size:.85rem">Loadingâ€¦</p>
        </div>
      </div>

    </div>
  </div>

</main>

<div id="toast"></div>

<script>
  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let currentFilter = '';
  let isAdmin = {{ 'true' if is_admin else 'false' }};
  let crawlActive = false;

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('DOMContentLoaded', () => {
    if (isAdmin) {
      document.getElementById('tab-users').classList.add('visible');
    }
    fetchStats();
    loadHits();
    pollCrawlStatus();
    setInterval(() => { fetchStats(); loadHits(currentFilter); }, 30000);
    setInterval(pollCrawlStatus, 5000);
  });

  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchTab(tab, btn) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('panel-' + tab).classList.add('active');
    btn.classList.add('active');
    if (tab === 'keywords') loadKeywords();
    if (tab === 'seeds') loadSeeds();
    if (tab === 'users' && isAdmin) loadUsers();
    if (tab === 'settings') loadSettings();
  }

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show ' + type;
    setTimeout(() => t.className = '', 3000);
  }

  // â”€â”€ Escape HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function fmtTime(iso) {
    if (!iso) return 'â€”';
    const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
  }

  // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchStats() {
    try {
      const res = await fetch('/api/stats');
      const data = await res.json();
      document.getElementById('statSessions').textContent = (data.total_sessions || 0).toLocaleString();
      document.getElementById('statPages').textContent = (data.total_pages || 0).toLocaleString();
      document.getElementById('statHits').textContent = (data.total_hits || 0).toLocaleString();
      const el = document.getElementById('topKeywords');
      if (!data.top_keywords || !data.top_keywords.length) {
        el.innerHTML = '<span style="color:var(--muted);font-size:.85rem">No hits yet.</span>';
      } else {
        el.innerHTML = data.top_keywords.map(k =>
          `<div class="kw-pill" onclick="filterByKeyword('${esc(k.keyword)}')">${esc(k.keyword)}<span class="count">${k.count}</span></div>`
        ).join('');
      }
    } catch(e) {
      document.getElementById('statusDot').style.background = 'var(--red)';
    }
  }

  // â”€â”€ Hits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadHits(keyword = '') {
    const el = document.getElementById('hitsContainer');
    el.innerHTML = '<div class="empty"><p>Loadingâ€¦</p></div>';
    try {
      const url = '/api/hits?limit=100' + (keyword ? '&keyword=' + encodeURIComponent(keyword) : '');
      const hits = await (await fetch(url)).json();
      if (!hits.length) {
        el.innerHTML = `<div class="empty"><div class="icon">ğŸ”</div><p>No keyword hits found${keyword ? ` for "${esc(keyword)}"` : ''}.</p><p style="margin-top:8px">Start a crawl to begin monitoring.</p></div>`;
        return;
      }
      el.innerHTML = `<table>
        <thead><tr><th>Keyword</th><th>Category</th><th>URL</th><th>Context</th><th>Depth</th><th>Found At</th></tr></thead>
        <tbody>${hits.map(h => `<tr>
          <td><span class="keyword-tag">${esc(h.keyword)}</span></td>
          <td><span class="cat-tag">${esc(h.category)}</span></td>
          <td class="url-cell">${esc(h.url)}</td>
          <td class="ctx-cell">${esc((h.context||'').slice(0,250))}</td>
          <td style="color:var(--muted)">${h.depth}</td>
          <td class="time-cell">${fmtTime(h.found_at)}</td>
        </tr>`).join('')}</tbody></table>`;
    } catch(e) {
      el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading hits.</div>';
    }
  }

  function filterByKeyword(kw) { currentFilter = kw; document.getElementById('keywordFilter').value = kw; loadHits(kw); }
  function applyFilter() { currentFilter = document.getElementById('keywordFilter').value.trim(); loadHits(currentFilter); }
  function clearFilter() { currentFilter = ''; document.getElementById('keywordFilter').value = ''; loadHits(); }

  // â”€â”€ Crawl â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function pollCrawlStatus() {
    try {
      const data = await (await fetch('/api/crawl/status')).json();
      crawlActive = data.active;
      const bar = document.getElementById('crawlStatusBar');
      const btn = document.getElementById('crawlBtn');
      const txt = document.getElementById('crawlStatusText');
      if (data.active && data.session) {
        bar.className = 'crawl-status';
        btn.className = 'crawl-btn running';
        btn.textContent = 'â¹ Stop Crawl';
        txt.textContent = `Crawl running â€” ${data.session.pages_crawled} pages crawled, ${data.session.hits_found} hits found`;
      } else {
        bar.className = 'crawl-status idle';
        btn.className = 'crawl-btn';
        btn.textContent = 'â–¶ Start Crawl';
        txt.textContent = 'No active crawl';
      }
    } catch(e) {}
  }

  async function toggleCrawl() {
    if (crawlActive) { toast('Stop the crawl from the server terminal: make stop', 'error'); return; }
    try {
      const res = await fetch('/api/crawl/start', { method: 'POST' });
      const data = await res.json();
      if (data.ok) { toast('Crawl started!'); pollCrawlStatus(); }
      else toast(data.error || 'Failed to start crawl', 'error');
    } catch(e) { toast('Error starting crawl', 'error'); }
  }

  // â”€â”€ Keywords â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadKeywords() {
    const el = document.getElementById('keywordsList');
    try {
      const data = await (await fetch('/api/keywords')).json();
      const cats = data.categories || {};
      if (!Object.keys(cats).length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸ”‘</div><p>No keywords yet. Add some above.</p></div>';
        return;
      }
      el.innerHTML = Object.entries(cats).map(([cat, kws]) => `
        <div style="margin-bottom:20px">
          <div class="section-title">${esc(cat)}</div>
          <table><thead><tr><th>Keyword</th><th style="width:80px">Action</th></tr></thead>
          <tbody>${(kws||[]).map(kw => `<tr>
            <td><span class="keyword-tag">${esc(kw)}</span></td>
            <td><button class="btn btn-danger" onclick="deleteKeyword('${esc(kw).replace(/'/g,"\\'")}','${esc(cat).replace(/'/g,"\\'")}')">Remove</button></td>
          </tr>`).join('')}</tbody></table>
        </div>`).join('');
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading keywords.</div>'; }
  }

  async function addKeyword() {
    const kw = document.getElementById('newKeyword').value.trim();
    const cat = document.getElementById('newCategory').value;
    if (!kw) { toast('Enter a keyword first', 'error'); return; }
    const res = await fetch('/api/keywords', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({keyword:kw,category:cat}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newKeyword').value = ''; toast('Keyword added!'); loadKeywords(); }
    else toast(data.error || 'Error', 'error');
  }

  async function deleteKeyword(kw, cat) {
    const res = await fetch('/api/keywords', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({keyword:kw,category:cat}) });
    const data = await res.json();
    if (data.ok) { toast('Keyword removed'); loadKeywords(); }
    else toast(data.error || 'Error', 'error');
  }

  // â”€â”€ Seeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSeeds() {
    const el = document.getElementById('seedsList');
    try {
      const data = await (await fetch('/api/seeds')).json();
      if (!data.seeds || !data.seeds.length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸŒ±</div><p>No seeds yet. Add .onion URLs above.</p></div>';
        return;
      }
      el.innerHTML = data.seeds.map(s => `
        <div class="seed-item">
          <span>${esc(s)}</span>
          <button class="btn btn-danger" onclick="deleteSeed('${esc(s).replace(/'/g,"\\'")}')">Remove</button>
        </div>`).join('');
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading seeds.</div>'; }
  }

  async function addSeed() {
    const url = document.getElementById('newSeed').value.trim();
    if (!url) { toast('Enter a URL first', 'error'); return; }
    const res = await fetch('/api/seeds', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({url}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newSeed').value = ''; toast('Seed added!'); loadSeeds(); }
    else toast(data.error || 'Error', 'error');
  }

  async function deleteSeed(url) {
    const res = await fetch('/api/seeds', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({url}) });
    const data = await res.json();
    if (data.ok) { toast('Seed removed'); loadSeeds(); }
    else toast(data.error || 'Error', 'error');
  }

  // â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadUsers() {
    const el = document.getElementById('usersList');
    try {
      const users = await (await fetch('/api/users')).json();
      if (!users.length) { el.innerHTML = '<div class="empty"><p>No users yet.</p></div>'; return; }
      el.innerHTML = `<table>
        <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>2FA</th><th>OAuth</th><th>Last Login</th><th></th></tr></thead>
        <tbody>${users.map(u => `<tr>
          <td><strong>${esc(u.username)}</strong></td>
          <td style="color:var(--muted)">${esc(u.email||'â€”')}</td>
          <td>${u.is_admin ? '<span class="badge-admin">Admin</span>' : '<span class="badge-user">User</span>'}</td>
          <td>${u.totp_enabled ? '<span class="badge-2fa">âœ“ On</span>' : '<span style="color:var(--muted);font-size:.8rem">Off</span>'}</td>
          <td style="color:var(--muted);font-size:.8rem">${esc(u.oauth_provider||'â€”')}</td>
          <td class="time-cell">${fmtTime(u.last_login)}</td>
          <td><button class="btn btn-danger" onclick="deleteUser(${u.id},'${esc(u.username)}')">Remove</button></td>
        </tr>`).join('')}</tbody></table>`;
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading users.</div>'; }
  }

  async function createUser() {
    const username = document.getElementById('newUsername').value.trim();
    const email = document.getElementById('newEmail').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const is_admin = document.getElementById('newUserRole').value === '1';
    if (!username || !password) { toast('Username and password required', 'error'); return; }
    const res = await fetch('/api/users', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username,email,password,is_admin}) });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('newUsername').value = '';
      document.getElementById('newEmail').value = '';
      document.getElementById('newUserPassword').value = '';
      toast('User created!'); loadUsers();
    } else toast(data.error || 'Error', 'error');
  }

  async function deleteUser(id, username) {
    if (!confirm(`Remove user "${username}"? This cannot be undone.`)) return;
    const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.ok) { toast('User removed'); loadUsers(); }
    else toast(data.error || 'Error', 'error');
  }

  // â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSettings() {
    try {
      const profile = await (await fetch('/api/settings/profile')).json();
      document.getElementById('profileInfo').innerHTML = `
        <div style="display:grid;gap:10px">
          <div style="display:flex;justify-content:space-between;font-size:.85rem">
            <span style="color:var(--muted)">Username</span><strong>${esc(profile.username)}</strong>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:.85rem">
            <span style="color:var(--muted)">Email</span><span>${esc(profile.email||'â€”')}</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:.85rem">
            <span style="color:var(--muted)">Role</span>
            ${profile.is_admin ? '<span class="badge-admin">Admin</span>' : '<span class="badge-user">User</span>'}
          </div>
          <div style="display:flex;justify-content:space-between;font-size:.85rem">
            <span style="color:var(--muted)">OAuth</span><span>${esc(profile.oauth_provider||'None')}</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:.85rem">
            <span style="color:var(--muted)">Last login</span><span class="time-cell">${fmtTime(profile.last_login)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:.85rem">
            <span style="color:var(--muted)">Member since</span><span class="time-cell">${fmtTime(profile.created_at)}</span>
          </div>
        </div>`;
      const totpEl = document.getElementById('totpStatus');
      if (profile.totp_enabled) {
        totpEl.innerHTML = `
          <p style="color:var(--green);font-size:.85rem;margin-bottom:16px">âœ“ Two-factor authentication is enabled.</p>
          <div class="form-group" style="margin-bottom:12px">
            <label>Enter your TOTP code or password to disable</label>
            <input type="text" id="disableTotpCode" placeholder="6-digit code or password" style="width:100%"/>
          </div>
          <button class="btn btn-danger" onclick="disableTotp()">Disable 2FA</button>`;
      } else {
        totpEl.innerHTML = `
          <p style="color:var(--muted);font-size:.85rem;margin-bottom:16px">2FA is not enabled. Set it up for extra security.</p>
          <a href="/totp/setup" class="btn btn-primary">Set Up 2FA</a>`;
      }
    } catch(e) {}
  }

  async function changePassword() {
    const body = {
      current_password: document.getElementById('currentPw').value,
      new_password: document.getElementById('newPw').value,
      confirm_password: document.getElementById('confirmPw').value,
    };
    const res = await fetch('/api/settings/password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('currentPw').value = '';
      document.getElementById('newPw').value = '';
      document.getElementById('confirmPw').value = '';
      toast('Password updated!');
    } else toast(data.error || 'Error', 'error');
  }

  async function disableTotp() {
    const val = document.getElementById('disableTotpCode').value.trim();
    const body = val.length === 6 && /^\d+$/.test(val)
      ? { totp_code: val }
      : { password: val };
    const res = await fetch('/api/settings/totp/disable', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const data = await res.json();
    if (data.ok) { toast('2FA disabled'); loadSettings(); }
    else toast(data.error || 'Invalid code', 'error');
  }
</script>
</body>
</html>
