<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dark Web Scanner â€” Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0d1117; --surface: #161b22; --surface2: #21262d;
      --border: #30363d; --text: #e6edf3; --muted: #8b949e;
      --accent: #58a6ff; --red: #f85149; --green: #3fb950;
      --yellow: #d29922; --purple: #bc8cff; --orange: #f0883e;
      --font: 'Segoe UI', system-ui, sans-serif;
      --mono: 'Cascadia Code', 'Fira Code', monospace;
    }
    body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; }

    /* â”€â”€ Nav â”€â”€ */
    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 28px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100;
    }
    .logo { display: flex; align-items: center; gap: 10px; padding: 14px 0; margin-right: 20px; }
    .logo h1 { font-size: 1rem; font-weight: 700; white-space: nowrap; }
    .logo .badge { background: var(--red); color: white; font-size: 0.65rem; padding: 2px 7px; border-radius: 20px; font-weight: 700; }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
    .status-dot.pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
    nav { display: flex; gap: 2px; flex: 1; }
    .nav-tab {
      padding: 16px 14px; font-size: 0.84rem; font-weight: 500; color: var(--muted);
      cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s;
      white-space: nowrap; background: none; border-top: none; border-left: none; border-right: none;
      font-family: var(--font);
    }
    .nav-tab:hover { color: var(--text); }
    .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .admin-only { display: none; }
    .admin-only.visible { display: block; }
    .header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; padding-left: 20px; }
    .btn-crawl { background: var(--green); color: #0d1117; border: none; border-radius: 6px; padding: 7px 14px; font-size: 0.8rem; font-weight: 700; cursor: pointer; white-space: nowrap; font-family: var(--font); }
    .btn-crawl:hover { opacity: .85; }
    .btn-crawl.running { background: var(--red); color: white; }
    .user-pill { color: var(--muted); font-size: 0.82rem; }
    .sign-out { color: var(--muted); font-size: 0.8rem; text-decoration: none; }
    .sign-out:hover { color: var(--red); }

    /* â”€â”€ Layout â”€â”€ */
    main { padding: 28px; max-width: 1400px; margin: 0 auto; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Live crawl card â”€â”€ */
    .crawl-card {
      border-radius: 10px; padding: 18px 24px; margin-bottom: 24px;
      display: flex; align-items: center; gap: 20px;
      border: 1px solid var(--border); background: var(--surface);
      transition: all .3s;
    }
    .crawl-card.active { border-color: rgba(63,185,80,.4); background: rgba(63,185,80,.06); }
    .crawl-card.active .crawl-dot { background: var(--green); animation: pulse 1.2s infinite; }
    .crawl-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
    .crawl-info { flex: 1; }
    .crawl-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; }
    .crawl-sub { color: var(--muted); font-size: 0.8rem; }
    .crawl-stats { display: flex; gap: 24px; }
    .crawl-stat { text-align: center; }
    .crawl-stat .val { font-size: 1.4rem; font-weight: 700; color: var(--accent); }
    .crawl-stat .lbl { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }

    /* â”€â”€ Stats grid â”€â”€ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 18px 20px; }
    .stat-card .lbl { color: var(--muted); font-size: 0.72rem; text-transform: uppercase; letter-spacing: .08em; margin-bottom: 6px; }
    .stat-card .val { font-size: 1.9rem; font-weight: 700; color: var(--accent); }

    /* â”€â”€ Panel â”€â”€ */
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
    .panel-header { padding: 13px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .panel-header h2 { font-size: 0.88rem; font-weight: 600; }
    .panel-body { padding: 18px; }

    /* â”€â”€ Tables â”€â”€ */
    table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
    th { text-align: left; padding: 9px 12px; color: var(--muted); font-weight: 500; font-size: 0.72rem; text-transform: uppercase; letter-spacing: .05em; border-bottom: 1px solid var(--border); }
    td { padding: 11px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface2); }
    .keyword-tag { display: inline-block; background: rgba(88,166,255,.12); color: var(--accent); border: 1px solid rgba(88,166,255,.25); border-radius: 4px; padding: 2px 7px; font-size: 0.75rem; font-weight: 600; font-family: var(--mono); }
    .cat-tag { display: inline-block; background: rgba(188,140,255,.1); color: var(--purple); border: 1px solid rgba(188,140,255,.2); border-radius: 4px; padding: 2px 7px; font-size: 0.73rem; }
    .url-cell { font-family: var(--mono); font-size: 0.75rem; color: var(--accent); word-break: break-all; max-width: 240px; }
    .ctx-cell { color: var(--muted); font-size: 0.76rem; font-family: var(--mono); max-width: 340px; white-space: pre-wrap; word-break: break-word; }
    .time-cell { color: var(--muted); font-size: 0.73rem; white-space: nowrap; }
    .status-badge { border-radius: 4px; padding: 2px 8px; font-size: 0.72rem; font-weight: 600; }
    .status-completed { background: rgba(63,185,80,.12); color: var(--green); border: 1px solid rgba(63,185,80,.25); }
    .status-running { background: rgba(88,166,255,.12); color: var(--accent); border: 1px solid rgba(88,166,255,.25); }
    .status-failed { background: rgba(248,81,73,.12); color: var(--red); border: 1px solid rgba(248,81,73,.25); }

    /* â”€â”€ Session expand â”€â”€ */
    .session-row { cursor: pointer; }
    .session-row:hover td { background: rgba(88,166,255,.05); }
    .session-detail { display: none; }
    .session-detail td { padding: 0; background: var(--bg) !important; }
    .session-detail-inner { padding: 12px 20px; border-top: 1px solid var(--border); }

    /* â”€â”€ Top keywords pills â”€â”€ */
    .kw-pills { display: flex; flex-wrap: wrap; gap: 8px; padding: 14px 18px; }
    .kw-pill { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 0.79rem; display: flex; align-items: center; gap: 7px; cursor: pointer; transition: border-color .15s; }
    .kw-pill:hover { border-color: var(--accent); color: var(--accent); }
    .kw-pill .count { background: var(--accent); color: #0d1117; border-radius: 10px; padding: 1px 7px; font-size: 0.68rem; font-weight: 700; }

    /* â”€â”€ Forms â”€â”€ */
    .form-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 18px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group label { font-size: 0.78rem; color: var(--muted); }
    input[type="text"], input[type="email"], input[type="password"], select {
      background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); padding: 7px 11px; font-size: 0.83rem; font-family: var(--font);
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    .btn { border: none; border-radius: 6px; padding: 7px 14px; font-size: 0.83rem; font-weight: 600; cursor: pointer; font-family: var(--font); transition: opacity .15s; }
    .btn-primary { background: var(--accent); color: #0d1117; }
    .btn-primary:hover { opacity: .85; }
    .btn-danger { background: rgba(248,81,73,.12); color: var(--red); border: 1px solid rgba(248,81,73,.25); }
    .btn-danger:hover { background: rgba(248,81,73,.22); }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--accent); }
    .btn-report { background: var(--purple); color: #0d1117; font-weight: 700; }
    .btn-report:hover { opacity: .85; }

    /* â”€â”€ Seeds / channels â”€â”€ */
    .seed-item { display: flex; align-items: center; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid var(--border); font-family: var(--mono); font-size: 0.79rem; color: var(--accent); }
    .seed-item:last-child { border-bottom: none; }

    /* â”€â”€ User badges â”€â”€ */
    .badge-admin { background: rgba(248,81,73,.12); color: var(--red); border: 1px solid rgba(248,81,73,.25); border-radius: 4px; padding: 2px 7px; font-size: 0.7rem; font-weight: 600; }
    .badge-user { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); border-radius: 4px; padding: 2px 7px; font-size: 0.7rem; }
    .badge-2fa { background: rgba(63,185,80,.1); color: var(--green); border: 1px solid rgba(63,185,80,.25); border-radius: 4px; padding: 2px 7px; font-size: 0.7rem; }

    /* â”€â”€ Report tab â”€â”€ */
    .report-hero { text-align: center; padding: 60px 20px; }
    .report-hero .icon { font-size: 3rem; margin-bottom: 16px; }
    .report-hero h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 8px; }
    .report-hero p { color: var(--muted); font-size: 0.88rem; margin-bottom: 28px; max-width: 480px; margin-left: auto; margin-right: auto; }
    .report-preview { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 24px; max-width: 560px; margin: 0 auto 28px; text-align: left; }
    .report-preview h3 { font-size: 0.85rem; font-weight: 600; margin-bottom: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; }
    .report-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.84rem; }
    .report-item:last-child { border-bottom: none; }
    .report-item .label { color: var(--muted); }

    /* â”€â”€ Empty â”€â”€ */
    .empty { padding: 50px; text-align: center; color: var(--muted); }
    .empty .icon { font-size: 2.2rem; margin-bottom: 10px; }
    .empty p { font-size: 0.84rem; }

    /* â”€â”€ Toast â”€â”€ */
    #toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 11px 18px; font-size: 0.84rem; opacity: 0; transform: translateY(8px); transition: all .25s; pointer-events: none; z-index: 999; }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.success { border-color: var(--green); color: var(--green); }
    #toast.error { border-color: var(--red); color: var(--red); }

    /* â”€â”€ Settings â”€â”€ */
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px; }
    .section-title { font-size: 0.77rem; font-weight: 600; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); margin-bottom: 14px; }

    /* â”€â”€ Info banner â”€â”€ */
    .info-banner { background: rgba(88,166,255,.06); border: 1px solid rgba(88,166,255,.2); border-radius: 6px; padding: 10px 14px; font-size: 0.8rem; color: var(--muted); margin-top: 14px; }
    code { color: var(--accent); background: var(--bg); padding: 1px 5px; border-radius: 3px; font-family: var(--mono); font-size: .85em; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="status-dot" id="statusDot"></div>
    <h1>Dark Web Scanner</h1>
    <span class="badge">THREAT INTEL</span>
  </div>
  <nav>
    <button class="nav-tab active" onclick="switchTab('dashboard', this)">ğŸ“Š Dashboard</button>
    <button class="nav-tab" onclick="switchTab('keywords', this)">ğŸ”‘ Keywords</button>
    <button class="nav-tab" onclick="switchTab('seeds', this)">ğŸŒ± Seeds</button>
    <button class="nav-tab admin-only" id="tab-users" onclick="switchTab('users', this)">ğŸ‘¥ Users</button>
    <button class="nav-tab" onclick="switchTab('investigations', this)">ğŸ” Investigations</button>
    <button class="nav-tab" onclick="switchTab('iplookup', this)">ğŸŒ IP Lookup</button>
    <button class="nav-tab" onclick="switchTab('reports', this)">ğŸ“„ Reports</button>
    <button class="nav-tab" onclick="switchTab('settings', this)">âš™ï¸ Settings</button>
  </nav>
  <div class="header-right">
    <button class="btn-crawl" id="crawlBtn" onclick="toggleCrawl()">â–¶ Start Crawl</button>
    <span class="user-pill">{{ username }}</span>
    <a href="/logout" class="sign-out">Sign out</a>
  </div>
</header>

<main>

  <!-- â”€â”€ Dashboard Tab â”€â”€ -->
  <div class="tab-panel active" id="panel-dashboard">

    <!-- Live crawl card -->
    <div class="crawl-card" id="crawlCard">
      <div class="crawl-dot" id="crawlDot"></div>
      <div class="crawl-info">
        <div class="crawl-title" id="crawlTitle">No active crawl</div>
        <div class="crawl-sub" id="crawlSub">Run <code>make scan</code> on the server to start a dark web crawl</div>
      </div>
      <div class="crawl-stats" id="crawlLiveStats" style="display:none">
        <div class="crawl-stat"><div class="val" id="livePagesVal">0</div><div class="lbl">Pages</div></div>
        <div class="crawl-stat"><div class="val" id="liveHitsVal">0</div><div class="lbl">Hits</div></div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card"><div class="lbl">Crawl Sessions</div><div class="val" id="statSessions">â€”</div></div>
      <div class="stat-card"><div class="lbl">Pages Crawled</div><div class="val" id="statPages">â€”</div></div>
      <div class="stat-card"><div class="lbl">Keyword Hits</div><div class="val" id="statHits">â€”</div></div>
    </div>

    <!-- Top keywords -->
    <div class="panel">
      <div class="panel-header"><h2>Top Keywords</h2></div>
      <div class="kw-pills" id="topKeywords"><span style="color:var(--muted);font-size:.84rem">Loadingâ€¦</span></div>
    </div>

    <!-- Session history with expandable hits -->
    <div class="panel">
      <div class="panel-header">
        <h2>Scan Sessions</h2>
        <button class="btn btn-secondary" onclick="loadSessions()">â†» Refresh</button>
      </div>
      <div id="sessionsContainer"><div class="empty"><div class="icon">ğŸ”</div><p>Loadingâ€¦</p></div></div>
    </div>

  </div>

  <!-- â”€â”€ Keywords Tab â”€â”€ -->
  <div class="tab-panel" id="panel-keywords">
    <div class="panel">
      <div class="panel-header"><h2>Manage Keywords</h2></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group"><label>Keyword</label><input type="text" id="newKeyword" style="width:260px" placeholder="e.g. credential dump"/></div>
          <div class="form-group">
            <label>Category</label>
            <select id="newCategory" style="width:170px">
              <option value="custom">custom</option>
              <option value="threat_intel">threat_intel</option>
              <option value="brand_monitoring">brand_monitoring</option>
              <option value="infrastructure">infrastructure</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addKeyword()">+ Add</button>
        </div>
        <div id="keywordsList"><div class="empty"><div class="icon">ğŸ”‘</div><p>Loadingâ€¦</p></div></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Seeds Tab â”€â”€ -->
  <div class="tab-panel" id="panel-seeds">
    <div class="panel">
      <div class="panel-header"><h2>ğŸ§… Dark Web Seeds</h2><span style="color:var(--muted);font-size:.79rem">.onion URLs to crawl</span></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group"><label>Seed URL</label><input type="text" id="newSeed" style="width:400px" placeholder="http://example.onion"/></div>
          <button class="btn btn-primary" onclick="addSeed()">+ Add Seed</button>
        </div>
        <div id="seedsList"><div class="empty"><div class="icon">ğŸŒ±</div><p>Loadingâ€¦</p></div></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><h2>ğŸ“± Telegram Channels</h2><span style="color:var(--muted);font-size:.79rem">Public channels to scrape</span></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group"><label>Channel (without @)</label><input type="text" id="newChannel" style="width:260px" placeholder="channelname"/></div>
          <button class="btn btn-primary" onclick="addChannel()">+ Add Channel</button>
        </div>
        <div id="channelsList"><div class="empty"><div class="icon">ğŸ“±</div><p>Loadingâ€¦</p></div></div>
        <div class="info-banner">Run <code>make telegram-scan</code> on the server to scrape channels. First-time setup: <code>make telegram-auth</code></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Users Tab â”€â”€ -->
  <div class="tab-panel" id="panel-users">
    <div class="panel">
      <div class="panel-header"><h2>User Management</h2></div>
      <div class="panel-body">
        <div class="form-row" style="background:var(--surface2);padding:14px;border-radius:8px;border:1px solid var(--border)">
          <div class="form-group"><label>Username</label><input type="text" id="newUsername" placeholder="username"/></div>
          <div class="form-group"><label>Email</label><input type="email" id="newEmail" placeholder="optional"/></div>
          <div class="form-group"><label>Password</label><input type="password" id="newUserPassword" placeholder="Min 10 chars"/></div>
          <div class="form-group"><label>Role</label><select id="newUserRole" style="width:110px"><option value="0">User</option><option value="1">Admin</option></select></div>
          <button class="btn btn-primary" onclick="createUser()">+ Create</button>
        </div>
        <div id="usersList" style="margin-top:18px"><div class="empty"><div class="icon">ğŸ‘¥</div><p>Loadingâ€¦</p></div></div>
      </div>
    </div>
  </div>


  <!-- â”€â”€ Investigations Tab â”€â”€ -->
  <div class="tab-panel" id="panel-investigations">

    <!-- Create new investigation -->
    <div class="panel" style="margin-bottom:20px">
      <div class="panel-header"><h2>ğŸ” New Investigation</h2><span style="color:var(--muted);font-size:.79rem">Ad hoc targeted lookup</span></div>
      <div class="panel-body">
        <div class="form-group" style="margin-bottom:14px">
          <label>Investigation Name</label>
          <input type="text" id="invName" style="width:360px" placeholder="e.g. Subject Name, Incident 2026-02"/>
        </div>

        <div style="margin-bottom:14px">
          <div class="section-title">Targets</div>
          <div id="invTargets" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-secondary" onclick="addTarget('email')">+ Email</button>
            <button class="btn btn-secondary" onclick="addTarget('name')">+ Name</button>
            <button class="btn btn-secondary" onclick="addTarget('keyword')">+ Keyword</button>
          </div>
        </div>

        <div class="info-banner" style="margin-bottom:14px">
          ğŸ“§ Emails will be checked against HIBP breach database (requires <code>HIBP_API_KEY</code> in .env) and searched in your dark web hits.<br/>
          ğŸ‘¤ Names and keywords will be searched across all captured dark web context.
        </div>

        <button class="btn btn-primary" onclick="runInvestigation()" id="invRunBtn" style="padding:8px 20px">
          â–¶ Run Investigation
        </button>
      </div>
    </div>

    <!-- Investigations list -->
    <div class="panel">
      <div class="panel-header">
        <h2>Past Investigations</h2>
        <button class="btn btn-secondary" onclick="loadInvestigations()">â†» Refresh</button>
      </div>
      <div id="investigationsList"><div class="empty"><div class="icon">ğŸ”</div><p>No investigations yet.</p></div></div>
    </div>

  </div>


  <!-- â”€â”€ IP Lookup Tab â”€â”€ -->
  <div class="tab-panel" id="panel-iplookup">

    <!-- Lookup form -->
    <div class="panel" style="margin-bottom:20px">
      <div class="panel-header">
        <h2>ğŸŒ IP Address Lookup</h2>
        <span style="color:var(--muted);font-size:.79rem">AbuseIPDB + VirusTotal enrichment</span>
      </div>
      <div class="panel-body">
        <div class="form-row" style="align-items:flex-end">
          <div class="form-group">
            <label>IP Address</label>
            <input type="text" id="ipInput" style="width:220px;font-family:var(--mono)" placeholder="e.g. 185.220.101.5" onkeydown="if(event.key==='Enter')runIPLookup()"/>
          </div>
          <button class="btn btn-primary" onclick="runIPLookup()" id="ipLookupBtn" style="padding:8px 20px">ğŸ” Investigate</button>
        </div>
        <div class="info-banner" style="margin-top:12px">
          Requires <code>ABUSEIPDB_API_KEY</code> and/or <code>VIRUSTOTAL_API_KEY</code> in .env â€” both free to get.<br/>
          âš  VirusTotal free tier: 4 requests/min â€” lookup takes ~35s due to rate limiting.
        </div>
        <!-- Inline result -->
        <div id="ipLookupResult" style="margin-top:18px;display:none"></div>
      </div>
    </div>

    <!-- Past IP lookups -->
    <div class="panel">
      <div class="panel-header">
        <h2>Past IP Lookups</h2>
        <button class="btn btn-secondary" onclick="loadIPInvestigations()">â†» Refresh</button>
      </div>
      <div id="ipInvestigationsList">
        <div class="empty"><div class="icon">ğŸŒ</div><p>No IP lookups yet.</p></div>
      </div>
    </div>

  </div>

  <!-- â”€â”€ Reports Tab â”€â”€ -->
  <div class="tab-panel" id="panel-reports">
    <div class="report-hero">
      <div class="icon">ğŸ“„</div>
      <h2>Executive Report</h2>
      <p>Generate a professional PDF threat intelligence report. Choose a specific scan session or generate an all-time summary.</p>

      <div class="report-preview" style="max-width:560px;margin:0 auto 20px">
        <h3>Scope</h3>
        <div class="report-item">
          <span class="label">Coverage</span>
          <select id="reportScope" style="background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:5px;font-size:.83rem" onchange="updateReportPreview()">
            <option value="all">All sessions (full history)</option>
          </select>
        </div>
        <div class="report-item"><span class="label">Executive Summary</span><span>Stats overview</span></div>
        <div class="report-item"><span class="label">Top Keywords</span><span>By hit count</span></div>
        <div class="report-item"><span class="label">Keyword Hits</span><span id="reportHitsLabel">Latest 200 hits</span></div>
        <div class="report-item"><span class="label">Session History</span><span id="reportSessionsLabel">All sessions</span></div>
      </div>

      <div id="reportStats" style="color:var(--muted);font-size:.84rem;margin-bottom:20px">Loading statsâ€¦</div>

      <button class="btn btn-report" onclick="downloadReport()" style="padding:12px 32px;font-size:1rem">
        â¬‡ Download PDF Report
      </button>
    </div>
  </div>

  <!-- â”€â”€ Settings Tab â”€â”€ -->
  <div class="tab-panel" id="panel-settings">
    <div class="settings-grid">
      <div class="panel">
        <div class="panel-header"><h2>Change Password</h2></div>
        <div class="panel-body">
          <div class="form-group" style="margin-bottom:10px"><label>Current Password</label><input type="password" id="currentPw" style="width:100%"/></div>
          <div class="form-group" style="margin-bottom:10px"><label>New Password</label><input type="password" id="newPw" style="width:100%"/></div>
          <div class="form-group" style="margin-bottom:14px"><label>Confirm New Password</label><input type="password" id="confirmPw" style="width:100%"/></div>
          <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><h2>Two-Factor Authentication</h2></div>
        <div class="panel-body" id="totpStatus"><p style="color:var(--muted);font-size:.84rem">Loadingâ€¦</p></div>
      </div>
      <div class="panel">
        <div class="panel-header"><h2>Account Info</h2></div>
        <div class="panel-body" id="profileInfo"><p style="color:var(--muted);font-size:.84rem">Loadingâ€¦</p></div>
      </div>
    </div>
  </div>

</main>

<div id="toast"></div>

<script>
  let isAdmin = {{ 'true' if is_admin else 'false' }};
  let crawlActive = false;

  document.addEventListener('DOMContentLoaded', () => {
    if (isAdmin) document.getElementById('tab-users').classList.add('visible');
    fetchStats();
    loadSessions();
    pollCrawlStatus();
    setInterval(() => { fetchStats(); if (crawlActive) loadSessions(); }, 15000);
    setInterval(pollCrawlStatus, 5000);
  });

  function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function fmtTime(iso) {
    if (!iso) return 'â€”';
    try {
      const d = new Date(iso.includes('T') ? (iso.endsWith('Z') ? iso : iso + 'Z') : iso);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    } catch(e) { return iso; }
  }
  function toast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show ' + type;
    setTimeout(() => t.className = '', 3000);
  }

  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchTab(tab, btn) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('panel-' + tab).classList.add('active');
    btn.classList.add('active');
    if (tab === 'keywords') loadKeywords();
    if (tab === 'seeds') { loadSeeds(); loadChannels(); }
    if (tab === 'users' && isAdmin) loadUsers();
    if (tab === 'investigations') loadInvestigations();
    if (tab === 'iplookup') loadIPInvestigations();
    if (tab === 'reports') loadReportPreview();
    if (tab === 'settings') loadSettings();
  }

  // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchStats() {
    try {
      const data = await (await fetch('/api/stats')).json();
      document.getElementById('statSessions').textContent = (data.total_sessions||0).toLocaleString();
      document.getElementById('statPages').textContent = (data.total_pages||0).toLocaleString();
      document.getElementById('statHits').textContent = (data.total_hits||0).toLocaleString();
      const el = document.getElementById('topKeywords');
      if (!data.top_keywords?.length) {
        el.innerHTML = '<span style="color:var(--muted);font-size:.84rem;padding:4px">No hits yet.</span>';
      } else {
        el.innerHTML = data.top_keywords.map(k =>
          `<div class="kw-pill" onclick="filterSession('${esc(k.keyword)}')">${esc(k.keyword)}<span class="count">${k.count}</span></div>`
        ).join('');
      }
    } catch(e) { document.getElementById('statusDot').style.background='var(--red)'; }
  }

  // â”€â”€ Crawl status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function pollCrawlStatus() {
    try {
      const data = await (await fetch('/api/crawl/status')).json();
      crawlActive = data.active;
      const card = document.getElementById('crawlCard');
      const dot = document.getElementById('crawlDot');
      const title = document.getElementById('crawlTitle');
      const sub = document.getElementById('crawlSub');
      const liveStats = document.getElementById('crawlLiveStats');
      const btn = document.getElementById('crawlBtn');

      if (data.active && data.session) {
        card.className = 'crawl-card active';
        dot.className = 'crawl-dot pulse';
        title.textContent = 'Crawl in progress';
        sub.innerHTML = `Session #${data.session.id} â€” started ${fmtTime(data.session.started_at)}`;
        liveStats.style.display = 'flex';
        document.getElementById('livePagesVal').textContent = (data.session.pages_crawled||0).toLocaleString();
        document.getElementById('liveHitsVal').textContent = (data.session.hits_found||0).toLocaleString();
        btn.className = 'btn-crawl running';
        btn.textContent = 'â¹ Runningâ€¦';
        btn.disabled = true;
      } else {
        card.className = 'crawl-card';
        dot.className = 'crawl-dot';
        title.textContent = 'No active crawl';
        sub.innerHTML = 'Run <code>make scan</code> on the server to start a dark web crawl';
        liveStats.style.display = 'none';
        btn.className = 'btn-crawl';
        btn.textContent = 'â–¶ Start Crawl';
        btn.disabled = false;
      }
    } catch(e) {}
  }

  async function toggleCrawl() {
    toast('Run "make scan" on the server to start a crawl', 'error');
  }

  // â”€â”€ Sessions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let expandedSessions = new Set();

  async function loadSessions() {
    const el = document.getElementById('sessionsContainer');
    try {
      const sessions = await (await fetch('/api/sessions')).json();
      if (!sessions.length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸ“‹</div><p>No crawl sessions yet. Run <code>make scan</code> to start.</p></div>';
        return;
      }
      el.innerHTML = `<table>
        <thead><tr><th>Session</th><th>Started</th><th>Duration</th><th>Pages</th><th>Hits</th><th>Status</th></tr></thead>
        <tbody id="sessionRows">${sessions.map(s => buildSessionRow(s)).join('')}</tbody>
      </table>`;
      // Re-expand previously expanded sessions
      expandedSessions.forEach(id => expandSession(id, false));
    } catch(e) {
      el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading sessions.</div>';
    }
  }

  function buildSessionRow(s) {
    const started = fmtTime(s.started_at);
    const statusClass = `status-${s.status || 'completed'}`;
    let duration = 'â€”';
    if (s.started_at && s.ended_at) {
      const secs = Math.round((new Date(s.ended_at.endsWith('Z')?s.ended_at:s.ended_at+'Z') - new Date(s.started_at.endsWith('Z')?s.started_at:s.started_at+'Z')) / 1000);
      duration = secs < 60 ? `${secs}s` : `${Math.floor(secs/60)}m ${secs%60}s`;
    } else if (s.status === 'running') {
      duration = 'Runningâ€¦';
    }
    return `
      <tr class="session-row" onclick="expandSession(${s.id}, true)" id="sess-${s.id}">
        <td style="font-family:var(--mono);font-size:.8rem;color:var(--muted)">#${s.id}</td>
        <td class="time-cell">${started}</td>
        <td class="time-cell">${duration}</td>
        <td><strong>${(s.pages_crawled||0).toLocaleString()}</strong></td>
        <td><strong style="color:${s.hits_found>0?'var(--accent)':'var(--muted)'}">${(s.hits_found||0).toLocaleString()}</strong></td>
        <td><span class="status-badge ${statusClass}">${s.status||'completed'}</span></td>
      </tr>
      <tr class="session-detail" id="sess-detail-${s.id}">
        <td colspan="6"><div class="session-detail-inner" id="sess-inner-${s.id}">Loadingâ€¦</div></td>
      </tr>`;
  }

  async function expandSession(id, toggle) {
    const detailRow = document.getElementById(`sess-detail-${id}`);
    if (!detailRow) return;
    const isOpen = detailRow.style.display === 'table-row';
    if (toggle && isOpen) {
      detailRow.style.display = 'none';
      expandedSessions.delete(id);
      return;
    }
    detailRow.style.display = 'table-row';
    expandedSessions.add(id);
    const inner = document.getElementById(`sess-inner-${id}`);
    inner.innerHTML = 'Loading hitsâ€¦';
    try {
      const hits = await (await fetch(`/api/sessions/${id}/hits`)).json();
      if (!hits.length) { inner.innerHTML = '<p style="color:var(--muted);font-size:.83rem;padding:8px 0">No keyword hits in this session.</p>'; return; }
      inner.innerHTML = `<table style="margin:8px 0">
        <thead><tr><th>Keyword</th><th>Category</th><th>URL</th><th>Context</th><th>Found At</th></tr></thead>
        <tbody>${hits.map(h => `<tr>
          <td><span class="keyword-tag">${esc(h.keyword)}</span></td>
          <td><span class="cat-tag">${esc(h.category)}</span></td>
          <td class="url-cell">${esc(h.url)}</td>
          <td class="ctx-cell">${esc((h.context||'').slice(0,200))}</td>
          <td class="time-cell">${fmtTime(h.found_at)}</td>
        </tr>`).join('')}</tbody>
      </table>`;
    } catch(e) { inner.innerHTML = '<p style="color:var(--red)">Error loading hits.</p>'; }
  }

  function filterSession(kw) { /* future: filter sessions by keyword */ }

  // â”€â”€ Keywords â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadKeywords() {
    const el = document.getElementById('keywordsList');
    try {
      const data = await (await fetch('/api/keywords')).json();
      const cats = data.categories || {};
      if (!Object.keys(cats).length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸ”‘</div><p>No keywords yet.</p></div>';
        return;
      }
      el.innerHTML = Object.entries(cats).map(([cat, kws]) => `
        <div class="kw-category" data-cat="${esc(cat).toLowerCase()}" style="margin-bottom:18px">
          <div class="section-title">${esc(cat)}</div>
          <table><thead><tr><th>Keyword</th><th style="width:80px">Action</th></tr></thead>
          <tbody>${(kws||[]).map(kw => `<tr class="kw-row" data-kw="${esc(kw).toLowerCase()}">
            <td><span class="keyword-tag">${esc(kw)}</span></td>
            <td><button class="btn btn-danger" onclick="deleteKeyword('${esc(kw).replace(/'/g,"\\'")}','${esc(cat).replace(/'/g,"\\'")}')">Remove</button></td>
          </tr>`).join('')}</tbody></table>
        </div>`).join('');
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error.</div>'; }
  }

  async function addKeyword() {
    const kw = document.getElementById('newKeyword').value.trim();
    const cat = document.getElementById('newCategory').value;
    if (!kw) { toast('Enter a keyword first', 'error'); return; }
    const res = await fetch('/api/keywords', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({keyword:kw,category:cat}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newKeyword').value=''; toast('Keyword added!'); loadKeywords(); }
    else toast(data.error||'Error', 'error');
  }

  async function deleteKeyword(kw, cat) {
    const res = await fetch('/api/keywords', { method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({keyword:kw,category:cat}) });
    const data = await res.json();
    if (data.ok) { toast('Removed'); loadKeywords(); }
    else toast(data.error||'Error','error');
  }

  // â”€â”€ Seeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSeeds() {
    const el = document.getElementById('seedsList');
    try {
      const data = await (await fetch('/api/seeds')).json();
      if (!data.seeds?.length) { el.innerHTML = '<div class="empty"><div class="icon">ğŸŒ±</div><p>No seeds yet.</p></div>'; return; }
      el.innerHTML = data.seeds.map(s => `
        <div class="seed-item">
          <span>${esc(s)}</span>
          <button class="btn btn-danger" onclick="deleteSeed('${esc(s).replace(/'/g,"\\'")}')">Remove</button>
        </div>`).join('');
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error.</div>'; }
  }

  async function addSeed() {
    const url = document.getElementById('newSeed').value.trim();
    if (!url) { toast('Enter a URL', 'error'); return; }
    const res = await fetch('/api/seeds', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newSeed').value=''; toast('Seed added!'); loadSeeds(); }
    else toast(data.error||'Error','error');
  }

  async function deleteSeed(url) {
    const res = await fetch('/api/seeds', { method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url}) });
    const data = await res.json();
    if (data.ok) { toast('Removed'); loadSeeds(); }
    else toast(data.error||'Error','error');
  }

  // â”€â”€ Telegram Channels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadChannels() {
    const el = document.getElementById('channelsList');
    if (!el) return;
    try {
      const data = await (await fetch('/api/telegram/channels')).json();
      if (!data.channels?.length) { el.innerHTML = '<div class="empty"><div class="icon">ğŸ“±</div><p>No channels yet.</p></div>'; return; }
      el.innerHTML = data.channels.map(ch => `
        <div class="seed-item">
          <span>@${esc(ch)}</span>
          <button class="btn btn-danger" onclick="deleteChannel('${esc(ch)}')">Remove</button>
        </div>`).join('');
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--muted)">Configure TELEGRAM_API_ID in .env</div>'; }
  }

  async function addChannel() {
    const ch = document.getElementById('newChannel').value.trim().replace(/^@/,'');
    if (!ch) { toast('Enter a channel username', 'error'); return; }
    const res = await fetch('/api/telegram/channels', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({channel:ch}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newChannel').value=''; toast('Channel added!'); loadChannels(); }
    else toast(data.error||'Error','error');
  }

  async function deleteChannel(ch) {
    const res = await fetch('/api/telegram/channels', { method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({channel:ch}) });
    const data = await res.json();
    if (data.ok) { toast('Removed'); loadChannels(); }
    else toast(data.error||'Error','error');
  }

  // â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadUsers() {
    const el = document.getElementById('usersList');
    try {
      const users = await (await fetch('/api/users')).json();
      if (!users.length) { el.innerHTML = '<div class="empty"><p>No users.</p></div>'; return; }
      el.innerHTML = `<table>
        <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>2FA</th><th>Last Login</th><th></th></tr></thead>
        <tbody>${users.map(u => `<tr>
          <td><strong>${esc(u.username)}</strong></td>
          <td style="color:var(--muted)">${esc(u.email||'â€”')}</td>
          <td>${u.is_admin?'<span class="badge-admin">Admin</span>':'<span class="badge-user">User</span>'}</td>
          <td>${u.totp_enabled?'<span class="badge-2fa">âœ“</span>':'<span style="color:var(--muted);font-size:.79rem">Off</span>'}</td>
          <td class="time-cell">${fmtTime(u.last_login)}</td>
          <td><button class="btn btn-danger" onclick="deleteUser(${u.id},'${esc(u.username)}')">Remove</button></td>
        </tr>`).join('')}</tbody></table>`;
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error.</div>'; }
  }

  async function createUser() {
    const username = document.getElementById('newUsername').value.trim();
    const email = document.getElementById('newEmail').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const is_admin = document.getElementById('newUserRole').value === '1';
    if (!username || !password) { toast('Username and password required', 'error'); return; }
    const res = await fetch('/api/users', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,email,password,is_admin}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newUsername').value=''; document.getElementById('newEmail').value=''; document.getElementById('newUserPassword').value=''; toast('User created!'); loadUsers(); }
    else toast(data.error||'Error','error');
  }

  async function deleteUser(id, username) {
    if (!confirm(`Remove "${username}"?`)) return;
    const res = await fetch(`/api/users/${id}`, { method:'DELETE' });
    const data = await res.json();
    if (data.ok) { toast('Removed'); loadUsers(); }
    else toast(data.error||'Error','error');
  }

  // â”€â”€ Reports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let reportSessions = [];

  async function loadReportPreview() {
    try {
      const [stats, sessions] = await Promise.all([
        (await fetch('/api/stats')).json(),
        (await fetch('/api/sessions')).json(),
      ]);
      reportSessions = sessions;
      document.getElementById('reportStats').innerHTML =
        `<strong>${stats.total_hits}</strong> keyword hits across <strong>${stats.total_sessions}</strong> sessions Â· <strong>${stats.total_pages}</strong> pages crawled`;
      // Populate session dropdown
      const sel = document.getElementById('reportScope');
      sel.innerHTML = '<option value="all">All sessions (full history)</option>';
      sessions.forEach(s => {
        const started = fmtTime(s.started_at);
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `Session #${s.id} â€” ${started} (${s.hits_found} hits, ${s.pages_crawled} pages)`;
        sel.appendChild(opt);
      });
    } catch(e) {}
  }

  function updateReportPreview() {
    const val = document.getElementById('reportScope').value;
    if (val === 'all') {
      document.getElementById('reportHitsLabel').textContent = 'Latest 200 hits';
      document.getElementById('reportSessionsLabel').textContent = 'All sessions';
    } else {
      const s = reportSessions.find(x => x.id == val);
      if (s) {
        document.getElementById('reportHitsLabel').textContent = `${s.hits_found} hits from this session`;
        document.getElementById('reportSessionsLabel').textContent = `Session #${s.id} only`;
      }
    }
  }

  function downloadReport() {
    const btn = document.querySelector('.btn-report');
    btn.textContent = 'â³ Generatingâ€¦';
    btn.disabled = true;
    const scope = document.getElementById('reportScope').value;
    const url = scope === 'all' ? '/api/report/pdf' : `/api/report/pdf?session_id=${scope}`;
    window.location.href = url;
    setTimeout(() => { btn.textContent = 'â¬‡ Download PDF Report'; btn.disabled = false; }, 3000);
  }

  // â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSettings() {
    try {
      const profile = await (await fetch('/api/settings/profile')).json();
      document.getElementById('profileInfo').innerHTML = `
        <div style="display:grid;gap:9px">
          ${[['Username',profile.username],['Email',profile.email||'â€”'],['Role',profile.is_admin?'<span class="badge-admin">Admin</span>':'<span class="badge-user">User</span>'],['OAuth',profile.oauth_provider||'None'],['Last login',fmtTime(profile.last_login)],['Member since',fmtTime(profile.created_at)]].map(([l,v])=>`
          <div style="display:flex;justify-content:space-between;font-size:.84rem"><span style="color:var(--muted)">${l}</span><span>${v}</span></div>`).join('')}
        </div>`;
      const totpEl = document.getElementById('totpStatus');
      if (profile.totp_enabled) {
        totpEl.innerHTML = `<p style="color:var(--green);font-size:.84rem;margin-bottom:14px">âœ“ 2FA is enabled.</p>
          <div class="form-group" style="margin-bottom:10px"><label>TOTP code or password to disable</label><input type="text" id="disableTotpCode" style="width:100%"/></div>
          <button class="btn btn-danger" onclick="disableTotp()">Disable 2FA</button>`;
      } else {
        totpEl.innerHTML = `<p style="color:var(--muted);font-size:.84rem;margin-bottom:14px">2FA is not enabled.</p>
          <a href="/totp/setup" class="btn btn-primary">Set Up 2FA</a>`;
      }
    } catch(e) {}
  }

  async function changePassword() {
    const body = { current_password: document.getElementById('currentPw').value, new_password: document.getElementById('newPw').value, confirm_password: document.getElementById('confirmPw').value };
    const res = await fetch('/api/settings/password', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const data = await res.json();
    if (data.ok) { document.getElementById('currentPw').value=''; document.getElementById('newPw').value=''; document.getElementById('confirmPw').value=''; toast('Password updated!'); }
    else toast(data.error||'Error','error');
  }

  async function disableTotp() {
    const val = document.getElementById('disableTotpCode').value.trim();
    const body = val.length===6 && /^\d+$/.test(val) ? {totp_code:val} : {password:val};
    const res = await fetch('/api/settings/totp/disable', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const data = await res.json();
    if (data.ok) { toast('2FA disabled'); loadSettings(); }
    else toast(data.error||'Invalid code','error');
  }

  // â”€â”€ Investigations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let targetCount = 0;

  function addTarget(type) {
    targetCount++;
    const id = `target-${targetCount}`;
    const labels = { email: 'ğŸ“§ Email', name: 'ğŸ‘¤ Name', keyword: 'ğŸ”‘ Keyword' };
    const placeholders = { email: 'user@example.com', name: 'John Doe', keyword: 'company name' };
    const colors = { email: 'var(--accent)', name: 'var(--green)', keyword: 'var(--purple)' };
    const div = document.createElement('div');
    div.id = id;
    div.style.cssText = 'display:flex;align-items:center;gap:8px';
    div.innerHTML = `
      <span style="font-size:.75rem;font-weight:600;color:${colors[type]};width:62px;flex-shrink:0">${labels[type]}</span>
      <input type="text" data-type="${type}" style="flex:1;max-width:360px" placeholder="${placeholders[type]}"/>
      <button class="btn btn-danger" onclick="document.getElementById('${id}').remove()" style="padding:4px 10px">âœ•</button>`;
    document.getElementById('invTargets').appendChild(div);
    div.querySelector('input').focus();
  }



  let _allKeywords = [];

  function filterKeywords() {
    const q = (document.getElementById('keywordSearch')?.value || '').toLowerCase();
    if (!q) {
      document.querySelectorAll('#keywordsList .kw-row').forEach(r => r.style.display = '');
      document.querySelectorAll('#keywordsList .kw-category').forEach(c => c.style.display = '');
      return;
    }
    document.querySelectorAll('#keywordsList .kw-category').forEach(cat => {
      let anyVisible = false;
      cat.querySelectorAll('.kw-row').forEach(row => {
        const match = (row.dataset.kw || '').includes(q) || (cat.dataset.cat || '').includes(q);
        row.style.display = match ? '' : 'none';
        if (match) anyVisible = true;
      });
      cat.style.display = anyVisible ? '' : 'none';
    });
  }
  async function stopCrawl() {
    if (!confirm('Send stop signal? The crawl will finish the current page then halt.')) return;
    const btn = document.getElementById('crawlStopBtn');
    btn.textContent = 'â³ Stoppingâ€¦';
    btn.disabled = true;
    try {
      const res = await fetch('/api/crawl/stop', { method: 'POST' });
      const data = await res.json();
      if (data.ok) toast('Stop signal sent â€” crawl will halt shortly.');
      else toast(data.error || 'Error', 'error');
    } catch(e) {
      toast('Network error', 'error');
    } finally {
      btn.textContent = 'â–  Stop Crawl';
      btn.disabled = false;
    }
  }
  async function runInvestigation() {
    const name = document.getElementById('invName').value.trim();
    if (!name) { toast('Enter an investigation name', 'error'); return; }

    const inputs = document.querySelectorAll('#invTargets input');
    const targets = [];
    inputs.forEach(inp => {
      const val = inp.value.trim();
      if (val) targets.push({ value: val, type: inp.dataset.type });
    });

    if (!targets.length) { toast('Add at least one target', 'error'); return; }

    const btn = document.getElementById('invRunBtn');
    btn.textContent = 'â³ Runningâ€¦';
    btn.disabled = true;

    try {
      const res = await fetch('/api/investigations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, targets })
      });
      const data = await res.json();
      if (data.ok) {
        toast(`Investigation complete! ID #${data.id}`);
        document.getElementById('invName').value = '';
        document.getElementById('invTargets').innerHTML = '';
        targetCount = 0;
        loadInvestigations();
      } else {
        toast(data.error || 'Error running investigation', 'error');
      }
    } catch(e) {
      toast('Network error', 'error');
    } finally {
      btn.textContent = 'â–¶ Run Investigation';
      btn.disabled = false;
    }
  }

  async function loadInvestigations() {
    const el = document.getElementById('investigationsList');
    try {
      const invs = await (await fetch('/api/investigations')).json();
      if (!invs.length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸ”</div><p>No investigations yet. Create one above.</p></div>';
        return;
      }
      el.innerHTML = `<table>
        <thead><tr><th>Name</th><th>Targets</th><th>Status</th><th>Created</th><th></th></tr></thead>
        <tbody>${invs.map(inv => `
          <tr class="session-row" onclick="expandInvestigation(${inv.id})" id="inv-${inv.id}">
            <td><strong>${esc(inv.name)}</strong></td>
            <td style="color:var(--muted)">${inv.target_count} target${inv.target_count !== 1 ? 's' : ''}</td>
            <td><span class="status-badge status-${inv.status}">${inv.status}</span></td>
            <td class="time-cell">${fmtTime(inv.created_at)}</td>
            <td><button class="btn btn-danger" onclick="event.stopPropagation();deleteInvestigation(${inv.id})" style="padding:3px 10px">âœ•</button></td>
          </tr>
          <tr class="session-detail" id="inv-detail-${inv.id}">
            <td colspan="5"><div class="session-detail-inner" id="inv-inner-${inv.id}"></div></td>
          </tr>`).join('')}
        </tbody></table>`;
    } catch(e) {
      el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading investigations.</div>';
    }
  }

  async function expandInvestigation(id) {
    const detail = document.getElementById(`inv-detail-${id}`);
    if (!detail) return;
    const isOpen = detail.style.display === 'table-row';
    if (isOpen) { detail.style.display = 'none'; return; }
    detail.style.display = 'table-row';
    const inner = document.getElementById(`inv-inner-${id}`);
    inner.innerHTML = 'Loadingâ€¦';
    try {
      const data = await (await fetch(`/api/investigations/${id}`)).json();
      if (!data.targets?.length) { inner.innerHTML = '<p style="color:var(--muted);padding:10px">No targets found.</p>'; return; }
      inner.innerHTML = data.targets.map(t => buildTargetCard(t)).join('');
    } catch(e) {
      inner.innerHTML = '<p style="color:var(--red)">Error loading results.</p>';
    }
  }

  function buildTargetCard(t) {
    const typeColors = { email: 'var(--accent)', name: 'var(--green)', keyword: 'var(--purple)' };
    const typeIcons = { email: 'ğŸ“§', name: 'ğŸ‘¤', keyword: 'ğŸ”‘' };
    let html = `<div style="border:1px solid var(--border);border-radius:8px;padding:14px;margin:10px 0;background:var(--bg)">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <span style="font-size:1.1rem">${typeIcons[t.target_type] || 'ğŸ¯'}</span>
        <strong style="color:${typeColors[t.target_type] || 'var(--text)'}">${esc(t.value)}</strong>
        <span style="font-size:.72rem;color:var(--muted)">${t.target_type}</span>
        ${t.error ? `<span style="color:var(--yellow);font-size:.75rem">âš  ${esc(t.error)}</span>` : ''}
      </div>`;

    // Breaches
    if (t.target_type === 'email') {
      if (t.breaches?.length) {
        html += `<div style="margin-bottom:12px">
          <div style="color:var(--red);font-weight:600;font-size:.82rem;margin-bottom:8px">âš  Found in ${t.breaches.length} breach(es)</div>
          ${t.breaches.map(b => `
            <div style="background:rgba(248,81,73,.06);border:1px solid rgba(248,81,73,.2);border-radius:6px;padding:10px;margin-bottom:6px">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                <strong style="color:var(--red)">${esc(b.breach_name)}</strong>
                <span style="color:var(--muted);font-size:.75rem">${esc(b.breach_date)}</span>
              </div>
              <div style="font-size:.75rem;color:var(--muted);margin-bottom:5px">${esc(b.description?.replace(/<[^>]+>/g,'').slice(0,200) || '')}</div>
              <div style="display:flex;flex-wrap:wrap;gap:4px">
                ${(b.data_classes||[]).map(dc => `<span style="background:rgba(248,81,73,.1);color:var(--red);border-radius:3px;padding:1px 6px;font-size:.7rem">${esc(dc)}</span>`).join('')}
              </div>
            </div>`).join('')}
        </div>`;
      } else if (!t.error) {
        html += `<div style="color:var(--green);font-size:.82rem;margin-bottom:12px">âœ“ No breaches found in HIBP</div>`;
      }
    }

    // Dark web hits
    if (t.darkweb_hits?.length) {
      html += `<div>
        <div style="color:var(--orange);font-weight:600;font-size:.82rem;margin-bottom:8px">ğŸ•¸ Found in ${t.darkweb_hits.length} dark web hit(s)</div>
        ${t.darkweb_hits.slice(0,5).map(h => `
          <div style="background:rgba(240,136,62,.06);border:1px solid rgba(240,136,62,.2);border-radius:6px;padding:10px;margin-bottom:6px">
            <div style="font-family:var(--mono);font-size:.75rem;color:var(--accent);margin-bottom:4px">${esc(h.url)}</div>
            <div style="font-size:.75rem;color:var(--muted);font-family:var(--mono)">${esc((h.context||'').slice(0,200))}</div>
            <div style="font-size:.7rem;color:var(--muted);margin-top:4px">${esc(h.found_at||'')}</div>
          </div>`).join('')}
        ${t.darkweb_hits.length > 5 ? `<p style="color:var(--muted);font-size:.75rem">â€¦and ${t.darkweb_hits.length - 5} more</p>` : ''}
      </div>`;
    } else {
      html += `<div style="color:var(--muted);font-size:.82rem">No matches in dark web database</div>`;
    }

    html += '</div>';
    return html;
  }

  async function deleteInvestigation(id) {
    if (!confirm('Delete this investigation?')) return;
    const res = await fetch(`/api/investigations/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.ok) { toast('Deleted'); loadInvestigations(); }
    else toast(data.error || 'Error', 'error');
  }


  // â”€â”€ IP Lookup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function runIPLookup() {
    const ip = document.getElementById('ipInput').value.trim();
    if (!ip) { toast('Enter an IP address', 'error'); return; }
    const btn = document.getElementById('ipLookupBtn');
    const resultEl = document.getElementById('ipLookupResult');
    btn.textContent = 'â³ Investigatingâ€¦';
    btn.disabled = true;
    resultEl.style.display = 'none';

    try {
      const res = await fetch('/api/ip-investigations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip })
      });
      const data = await res.json();
      if (!data.ok) { toast(data.error || 'Error', 'error'); return; }

      // Fetch full results and show inline
      const full = await (await fetch(`/api/ip-investigations/${data.id}`)).json();
      resultEl.style.display = 'block';
      resultEl.innerHTML = buildIPReport(full);
      loadIPInvestigations();
      toast(`Lookup complete for ${ip}`);
    } catch(e) {
      toast('Network error', 'error');
    } finally {
      btn.textContent = 'ğŸ” Investigate';
      btn.disabled = false;
    }
  }

  async function loadIPInvestigations() {
    const el = document.getElementById('ipInvestigationsList');
    try {
      const items = await (await fetch('/api/ip-investigations')).json();
      if (!items.length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸŒ</div><p>No IP lookups yet.</p></div>';
        return;
      }
      el.innerHTML = `<table>
        <thead><tr><th>IP Address</th><th>Country</th><th>ISP/AS Owner</th><th>Abuse Score</th><th>VT Malicious</th><th>Looked Up</th><th></th></tr></thead>
        <tbody>${items.map(i => {
          const score = i.abuse_score ?? 'â€”';
          const scoreColor = i.abuse_score >= 80 ? 'var(--red)' : i.abuse_score >= 30 ? 'var(--yellow)' : 'var(--green)';
          const vtColor = i.vt_malicious > 5 ? 'var(--red)' : i.vt_malicious > 0 ? 'var(--yellow)' : 'var(--green)';
          return `<tr class="session-row" onclick="expandIPInvestigation(${i.id})" id="ipinv-${i.id}">
            <td style="font-family:var(--mono);font-weight:600">${esc(i.ip)}</td>
            <td>${esc(i.country || 'â€”')}</td>
            <td style="color:var(--muted);font-size:.8rem">${esc(i.isp || 'â€”')}</td>
            <td><strong style="color:${scoreColor}">${score}%</strong></td>
            <td><strong style="color:${vtColor}">${i.vt_malicious ?? 'â€”'}</strong></td>
            <td class="time-cell">${fmtTime(i.created_at)}</td>
            <td><button class="btn btn-danger" onclick="event.stopPropagation();deleteIPInv(${i.id})" style="padding:3px 10px">âœ•</button></td>
          </tr>
          <tr class="session-detail" id="ipinv-detail-${i.id}">
            <td colspan="7"><div class="session-detail-inner" id="ipinv-inner-${i.id}"></div></td>
          </tr>`;
        }).join('')}</tbody></table>`;
    } catch(e) {
      el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading.</div>';
    }
  }

  async function expandIPInvestigation(id) {
    const detail = document.getElementById(`ipinv-detail-${id}`);
    if (!detail) return;
    if (detail.style.display === 'table-row') { detail.style.display = 'none'; return; }
    detail.style.display = 'table-row';
    const inner = document.getElementById(`ipinv-inner-${id}`);
    inner.innerHTML = 'Loadingâ€¦';
    try {
      const data = await (await fetch(`/api/ip-investigations/${id}`)).json();
      inner.innerHTML = buildIPReport(data);
    } catch(e) { inner.innerHTML = '<p style="color:var(--red)">Error.</p>'; }
  }

  function buildIPReport(data) {
    const a = data.abuseipdb || {};
    const v = data.virustotal || {};
    const aError = a.error;
    const vError = v.error;

    let html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:12px 0">`;

    // â”€â”€ AbuseIPDB Panel â”€â”€
    html += `<div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="font-size:1.1rem">ğŸ›¡</span>
        <strong style="font-size:.9rem">AbuseIPDB</strong>
        ${aError ? `<span style="color:var(--red);font-size:.75rem">âš  ${esc(aError)}</span>` : ''}
      </div>`;

    if (!aError && a.ip) {
      const score = a.abuse_confidence_score ?? 0;
      const scoreColor = score >= 80 ? 'var(--red)' : score >= 30 ? 'var(--yellow)' : 'var(--green)';
      html += `
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:2.8rem;font-weight:800;color:${scoreColor}">${score}%</div>
          <div style="color:var(--muted);font-size:.75rem">Abuse Confidence Score</div>
        </div>
        ${ipRow('IP', a.ip)}
        ${ipRow('Country', (a.country_name || '') + (a.country_code ? ` (${a.country_code})` : ''))}
        ${ipRow('ISP', a.isp)}
        ${ipRow('Domain', a.domain)}
        ${ipRow('Usage Type', a.usage_type)}
        ${ipRow('Tor Exit Node', a.is_tor ? 'âš  YES' : 'No', a.is_tor ? 'color:var(--red)' : '')}
        ${ipRow('Total Reports', a.total_reports + (a.num_distinct_users ? ` (${a.num_distinct_users} reporters)` : ''))}
        ${ipRow('Last Reported', a.last_reported_at ? fmtTime(a.last_reported_at) : 'Never')}
        ${a.hostnames?.length ? ipRow('Hostnames', a.hostnames.slice(0,3).join(', ')) : ''}`;

      if (a.reports?.length) {
        html += `<div style="margin-top:12px">
          <div style="font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:8px">Recent Reports</div>
          ${a.reports.slice(0,5).map(r => `
            <div style="background:var(--surface2);border-radius:5px;padding:8px;margin-bottom:5px;font-size:.76rem">
              <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                <span style="color:var(--red)">${(r.categories||[]).join(', ') || 'Unknown'}</span>
                <span style="color:var(--muted)">${r.reporter_country || ''}</span>
              </div>
              ${r.comment ? `<div style="color:var(--muted);font-family:var(--mono)">${esc(r.comment.slice(0,150))}</div>` : ''}
            </div>`).join('')}
        </div>`;
      }
    }
    html += `</div>`;

    // â”€â”€ VirusTotal Panel â”€â”€
    html += `<div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="font-size:1.1rem">ğŸ¦ </span>
        <strong style="font-size:.9rem">VirusTotal</strong>
        ${vError ? `<span style="color:var(--red);font-size:.75rem">âš  ${esc(vError)}</span>` : ''}
      </div>`;

    if (!vError && v.ip) {
      const stats = v.analysis_stats || {};
      const mal = stats.malicious || 0;
      const sus = stats.suspicious || 0;
      const total = v.total_engines || 0;
      const malColor = mal > 5 ? 'var(--red)' : mal > 0 ? 'var(--yellow)' : 'var(--green)';
      html += `
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:2.8rem;font-weight:800;color:${malColor}">${mal}/${total}</div>
          <div style="color:var(--muted);font-size:.75rem">Malicious Detections</div>
          <div style="font-size:.75rem;color:var(--muted);margin-top:2px">
            ${sus} suspicious Â· ${stats.harmless||0} harmless Â· ${stats.undetected||0} undetected
          </div>
        </div>
        ${ipRow('ASN', v.asn ? `AS${v.asn} â€” ${v.as_owner||''}` : 'â€”')}
        ${ipRow('Country', v.country || 'â€”')}
        ${ipRow('Continent', v.continent || 'â€”')}
        ${ipRow('Network', v.network || 'â€”')}
        ${ipRow('Registry', v.regional_internet_registry || 'â€”')}
        ${ipRow('Reputation', v.reputation !== undefined ? String(v.reputation) : 'â€”')}
        ${ipRow('JARM', v.jarm ? v.jarm.slice(0,24)+'â€¦' : 'â€”')}
        ${v.tags?.length ? ipRow('Tags', v.tags.join(', ')) : ''}
        ${ipRow('Last Analysis', v.last_analysis_date ? fmtTime(v.last_analysis_date) : 'â€”')}`;

      if (v.malicious_engines?.length) {
        html += `<div style="margin-top:12px">
          <div style="font-size:.75rem;font-weight:600;color:var(--red);text-transform:uppercase;margin-bottom:8px">Flagged by ${v.malicious_engines.length} engine(s)</div>
          ${v.malicious_engines.slice(0,8).map(e => `
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:.76rem">
              <span>${esc(e.engine)}</span>
              <span style="color:${e.category==='malicious'?'var(--red)':'var(--yellow)'}">${esc(e.result||e.category)}</span>
            </div>`).join('')}
        </div>`;
      }

      if (v.ssl_certificate) {
        const ssl = v.ssl_certificate;
        html += `<div style="margin-top:12px">
          <div style="font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:8px">SSL Certificate</div>
          ${ssl.subject_cn ? ipRow('Subject CN', ssl.subject_cn) : ''}
          ${ssl.issuer_org ? ipRow('Issuer', ssl.issuer_org) : ''}
          ${ssl.valid_from ? ipRow('Valid', ssl.valid_from + ' â†’ ' + (ssl.valid_to||'?')) : ''}
        </div>`;
      }
    }
    html += `</div></div>`;

    // â”€â”€ Resolutions â”€â”€
    if (v.resolutions?.length) {
      html += `<div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:4px">
        <div style="font-size:.8rem;font-weight:600;margin-bottom:10px">ğŸ“¡ Historical DNS Resolutions (${v.resolutions.length})</div>
        <table style="font-size:.78rem">
          <thead><tr><th>Hostname</th><th>Date</th></tr></thead>
          <tbody>${v.resolutions.slice(0,15).map(r => `<tr>
            <td style="font-family:var(--mono);color:var(--accent)">${esc(r.hostname||'â€”')}</td>
            <td class="time-cell">${r.date ? fmtTime(new Date(r.date*1000).toISOString()) : 'â€”'}</td>
          </tr>`).join('')}</tbody>
        </table>
      </div>`;
    }

    // â”€â”€ Communicating files â”€â”€
    if (v.communicating_files?.length) {
      html += `<div style="background:var(--bg);border:1px solid rgba(248,81,73,.25);border-radius:8px;padding:14px;margin-top:8px">
        <div style="font-size:.8rem;font-weight:600;color:var(--red);margin-bottom:10px">âš  Malware communicating with this IP (${v.communicating_files.length} samples)</div>
        <table style="font-size:.76rem">
          <thead><tr><th>Name</th><th>Type</th><th>SHA256</th><th>Malicious</th></tr></thead>
          <tbody>${v.communicating_files.map(f => `<tr>
            <td style="color:var(--red)">${esc(f.name||'unknown')}</td>
            <td style="color:var(--muted)">${esc(f.type||'â€”')}</td>
            <td style="font-family:var(--mono);font-size:.7rem;color:var(--muted)">${(f.sha256||'').slice(0,16)}â€¦</td>
            <td style="color:${f.malicious>0?'var(--red)':'var(--muted)'}">${f.malicious||0}</td>
          </tr>`).join('')}</tbody>
        </table>
      </div>`;
    }

    // â”€â”€ WHOIS â”€â”€
    if (v.whois) {
      html += `<details style="margin-top:8px">
        <summary style="cursor:pointer;font-size:.8rem;color:var(--muted);padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px">ğŸ“‹ WHOIS Data</summary>
        <pre style="background:var(--bg);border:1px solid var(--border);border-radius:0 0 6px 6px;padding:12px;font-size:.72rem;color:var(--muted);overflow-x:auto;max-height:300px;overflow-y:auto">${esc(v.whois)}</pre>
      </details>`;
    }

    return html;
  }

  function ipRow(label, value, style = '') {
    if (!value || value === 'â€”' || value === 'undefined') return '';
    return `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:.8rem">
      <span style="color:var(--muted)">${label}</span>
      <span style="text-align:right;max-width:60%;word-break:break-all;${style}">${esc(String(value))}</span>
    </div>`;
  }

  async function deleteIPInv(id) {
    if (!confirm('Delete this IP lookup?')) return;
    await fetch(`/api/ip-investigations/${id}`, { method: 'DELETE' });
    toast('Deleted');
    loadIPInvestigations();
  }

</script>
</body>
</html>
