<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23161b22'/%3E%3Ccircle cx='10' cy='16' r='3.5' fill='%23FF5C5C'/%3E%3Ccircle cx='19' cy='16' r='3.5' fill='%238b949e'/%3E%3Ccircle cx='28' cy='16' r='3.5' fill='%23d29922'/%3E%3C/svg%3E"/>
  <title>Threat Intelligence Platform â€” Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0d1117; --surface: #161b22; --surface2: #21262d;
      --border: #30363d; --text: #e6edf3; --muted: #8b949e;
      --accent: #58a6ff; --red: #f85149; --green: #3fb950;
      --yellow: #d29922; --purple: #bc8cff; --orange: #f0883e;
      --font: 'Segoe UI', system-ui, sans-serif;
      --mono: 'Cascadia Code', 'Fira Code', monospace;
    }
    body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; }

    /* â”€â”€ Nav â”€â”€ */
    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 28px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100;
    }
    .logo { display: flex; align-items: center; gap: 10px; padding: 14px 0; margin-right: 20px; }
    .logo h1 { font-size: 1rem; font-weight: 700; white-space: nowrap; }
    .logo .badge { background: var(--red); color: white; font-size: 0.65rem; padding: 2px 7px; border-radius: 20px; font-weight: 700; }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
    .status-dot.pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
    nav { display: flex; gap: 2px; flex: 1; }
    .nav-tab {
      padding: 16px 14px; font-size: 0.84rem; font-weight: 500; color: var(--muted);
      cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s;
      white-space: nowrap; background: none; border-top: none; border-left: none; border-right: none;
      font-family: var(--font);
    }
    .nav-tab:hover { color: var(--text); }
    .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .admin-only { display: none; }
    .admin-only.visible { display: block; }
    .header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; padding-left: 20px; }
    .theme-btn { background: none; border: 1px solid var(--border); color: var(--muted); padding: 5px 9px; cursor: pointer; font-size: 13px; border-radius: 4px; transition: all .2s; line-height:1; }
    .theme-btn:hover { border-color: var(--accent); color: var(--accent); }
    body.light { --bg: #f6f8fa; --surface: #ffffff; --surface2: #f0f2f5; --border: #d0d7de; --text: #1f2328; --muted: #656d76; }
    .btn-crawl { background: var(--green); color: #0d1117; border: none; border-radius: 6px; padding: 7px 14px; font-size: 0.8rem; font-weight: 700; cursor: pointer; white-space: nowrap; font-family: var(--font); }
    .btn-crawl:hover { opacity: .85; }
    .btn-crawl.running { background: var(--red); color: white; }
    .user-pill { color: var(--muted); font-size: 0.82rem; }
    .sign-out { color: var(--muted); font-size: 0.8rem; text-decoration: none; }
    .sign-out:hover { color: var(--red); }

    /* â”€â”€ Layout â”€â”€ */
    main { padding: 28px; max-width: 1400px; margin: 0 auto; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Live crawl card â”€â”€ */
    .crawl-card {
      border-radius: 10px; padding: 18px 24px; margin-bottom: 24px;
      display: flex; align-items: center; gap: 20px;
      border: 1px solid var(--border); background: var(--surface);
      transition: all .3s;
    }
    .crawl-card.active { border-color: rgba(63,185,80,.4); background: rgba(63,185,80,.06); }
    .crawl-card.active .crawl-dot { background: var(--green); animation: pulse 1.2s infinite; }
    .crawl-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
    .crawl-info { flex: 1; }
    .crawl-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; }
    .crawl-sub { color: var(--muted); font-size: 0.8rem; }
    .crawl-stats { display: flex; gap: 24px; }
    .crawl-stat { text-align: center; }
    .crawl-stat .val { font-size: 1.4rem; font-weight: 700; color: var(--accent); }
    .crawl-stat .lbl { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }

    /* â”€â”€ Stats grid â”€â”€ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 18px 20px; }
    .stat-card .lbl { color: var(--muted); font-size: 0.72rem; text-transform: uppercase; letter-spacing: .08em; margin-bottom: 6px; }
    .stat-card .val { font-size: 1.9rem; font-weight: 700; color: var(--accent); }

    /* â”€â”€ Panel â”€â”€ */
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
    .panel-header { padding: 13px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .panel-header h2 { font-size: 0.88rem; font-weight: 600; }
    .panel-body { padding: 18px; }

    /* â”€â”€ Tables â”€â”€ */
    table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
    th { text-align: left; padding: 9px 12px; color: var(--muted); font-weight: 500; font-size: 0.72rem; text-transform: uppercase; letter-spacing: .05em; border-bottom: 1px solid var(--border); }
    td { padding: 11px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface2); }
    .keyword-tag { display: inline-block; background: rgba(88,166,255,.12); color: var(--accent); border: 1px solid rgba(88,166,255,.25); border-radius: 4px; padding: 2px 7px; font-size: 0.75rem; font-weight: 600; font-family: var(--mono); }
    .cat-tag { display: inline-block; background: rgba(188,140,255,.1); color: var(--purple); border: 1px solid rgba(188,140,255,.2); border-radius: 4px; padding: 2px 7px; font-size: 0.73rem; }
    .url-cell { font-family: var(--mono); font-size: 0.75rem; color: var(--accent); word-break: break-all; max-width: 240px; }
    .ctx-cell { color: var(--muted); font-size: 0.76rem; font-family: var(--mono); max-width: 340px; white-space: pre-wrap; word-break: break-word; }
    .time-cell { color: var(--muted); font-size: 0.73rem; white-space: nowrap; }
    .status-badge { border-radius: 4px; padding: 2px 8px; font-size: 0.72rem; font-weight: 600; }
    .status-completed { background: rgba(63,185,80,.12); color: var(--green); border: 1px solid rgba(63,185,80,.25); }
    .status-running { background: rgba(88,166,255,.12); color: var(--accent); border: 1px solid rgba(88,166,255,.25); }
    .status-failed { background: rgba(248,81,73,.12); color: var(--red); border: 1px solid rgba(248,81,73,.25); }

    /* â”€â”€ Session expand â”€â”€ */
    .session-row { cursor: pointer; }
    .session-row:hover td { background: rgba(88,166,255,.05); }
    .session-detail { display: none; }
    .session-detail td { padding: 0; background: var(--bg) !important; }
    .session-detail-inner { padding: 12px 20px; border-top: 1px solid var(--border); }

    /* â”€â”€ Ransomware & Threat Actor cards â”€â”€ */
    .intel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 14px; padding: 20px; }
    .intel-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 18px; position: relative; transition: border-color .2s; }
    .intel-card:hover { border-color: var(--accent); }
    .intel-card.risk-critical { border-left: 3px solid var(--red); }
    .intel-card.risk-high { border-left: 3px solid var(--orange); }
    .intel-card.risk-medium { border-left: 3px solid var(--yellow); }
    .intel-card.risk-low { border-left: 3px solid var(--green); }
    .intel-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px; }
    .intel-card-name { font-size: 1rem; font-weight: 700; color: var(--text); }
    .intel-card-origin { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
    .intel-badges { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
    .intel-badge { font-size: 0.65rem; padding: 2px 7px; border-radius: 20px; font-weight: 700; font-family: var(--mono); letter-spacing: .04em; }
    .badge-critical { background: rgba(248,81,73,.15); color: var(--red); border: 1px solid rgba(248,81,73,.3); }
    .badge-high { background: rgba(240,136,62,.15); color: var(--orange); border: 1px solid rgba(240,136,62,.3); }
    .badge-medium { background: rgba(210,153,34,.15); color: var(--yellow); border: 1px solid rgba(210,153,34,.3); }
    .badge-active { background: rgba(63,185,80,.12); color: var(--green); border: 1px solid rgba(63,185,80,.25); }
    .badge-disrupted { background: rgba(139,148,158,.12); color: var(--muted); border: 1px solid var(--border); }
    .badge-sea { background: rgba(88,166,255,.12); color: var(--accent); border: 1px solid rgba(88,166,255,.25); }
    .badge-type { background: rgba(188,140,255,.12); color: var(--purple); border: 1px solid rgba(188,140,255,.25); }
    .intel-desc { font-size: 0.78rem; color: var(--muted); line-height: 1.55; margin-bottom: 10px; }
    .intel-ttps { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; }
    .ttp-tag { font-size: 0.65rem; padding: 2px 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--muted); }
    .intel-hits { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--muted); border-top: 1px solid var(--border); padding-top: 10px; margin-top: 10px; }
    .intel-hit-count { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
    .intel-hit-count.has-hits { color: var(--red); }
    .intel-filter-bar { display: flex; gap: 10px; padding: 16px 20px 0; flex-wrap: wrap; align-items: center; }
    .intel-filter-btn { padding: 5px 12px; font-size: 0.76rem; background: var(--surface); border: 1px solid var(--border); color: var(--muted); cursor: pointer; border-radius: 20px; transition: all .15s; }
    .intel-filter-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(88,166,255,.08); }
    .intel-search { flex: 1; max-width: 280px; padding: 6px 12px; background: var(--surface); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-size: 0.82rem; font-family: var(--mono); }
    .intel-search:focus { outline: none; border-color: var(--accent); }
    /* Digest subscriber list */
    .subscriber-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.83rem; }
    .subscriber-row:last-child { border-bottom: none; }
    /* â”€â”€ DNS Crawler â”€â”€ */
    .dns-input-bar { display:flex; gap:10px; padding:20px; align-items:center; flex-wrap:wrap; }
    .dns-input { flex:1; min-width:240px; max-width:420px; padding:9px 14px; background:var(--surface); border:1px solid var(--border); color:var(--text); border-radius:6px; font-size:.9rem; font-family:var(--mono); }
    .dns-input:focus { outline:none; border-color:var(--accent); }
    .dns-history { padding:0 20px 20px; }
    .dns-history-row { display:flex; align-items:center; gap:10px; padding:10px 14px; background:var(--surface); border:1px solid var(--border); border-radius:6px; margin-bottom:8px; cursor:pointer; transition:border-color .15s; }
    .dns-history-row:hover { border-color:var(--accent); }
    .dns-history-domain { font-family:var(--mono); font-size:.88rem; font-weight:700; color:var(--text); flex:1; }
    .dns-history-meta { font-size:.74rem; color:var(--muted); }
    .dns-detail { padding:0 20px 20px; }
    .dns-section { background:var(--surface); border:1px solid var(--border); border-radius:8px; margin-bottom:14px; overflow:hidden; }
    .dns-section-hdr { display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:var(--surface2); border-bottom:1px solid var(--border); cursor:pointer; user-select:none; }
    .dns-section-title { font-size:.85rem; font-weight:700; color:var(--text); }
    .dns-section-body { padding:14px 16px; }
    .dns-record-table { width:100%; border-collapse:collapse; font-size:.78rem; }
    .dns-record-table th { text-align:left; padding:6px 10px; background:var(--surface2); color:var(--muted); font-weight:600; font-size:.72rem; border-bottom:1px solid var(--border); }
    .dns-record-table td { padding:6px 10px; border-bottom:1px solid var(--border); vertical-align:top; word-break:break-all; }
    .dns-record-table tr:last-child td { border-bottom:none; }
    .dns-record-table tr:hover td { background:var(--surface2); }
    .dns-badge-ok { color:var(--green); font-size:.72rem; font-weight:700; }
    .dns-badge-warn { color:var(--yellow); font-size:.72rem; font-weight:700; }
    .dns-badge-fail { color:var(--red); font-size:.72rem; font-weight:700; }
    .dns-zt-success { background:rgba(248,81,73,.1); border:1px solid rgba(248,81,73,.3); border-radius:6px; padding:10px 14px; color:var(--red); font-size:.82rem; font-weight:700; }
    .dns-summary-cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:10px; margin-bottom:14px; }
    .dns-summary-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:14px; text-align:center; }
    .dns-summary-num { font-size:1.6rem; font-weight:800; color:var(--accent); }
    .dns-summary-label { font-size:.72rem; color:var(--muted); margin-top:2px; }
    .dns-running { display:flex; align-items:center; gap:10px; padding:20px; color:var(--muted); font-size:.85rem; }
    .dns-spinner { width:18px; height:18px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .kw-pills { display: flex; flex-wrap: wrap; gap: 8px; padding: 14px 18px; }
    .kw-pill { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 0.79rem; display: flex; align-items: center; gap: 7px; cursor: pointer; transition: border-color .15s; }
    .kw-pill:hover { border-color: var(--accent); color: var(--accent); }
    .kw-pill .count { background: var(--accent); color: #0d1117; border-radius: 10px; padding: 1px 7px; font-size: 0.68rem; font-weight: 700; }

    /* â”€â”€ Forms â”€â”€ */
    .form-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 18px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group label { font-size: 0.78rem; color: var(--muted); }
    input[type="text"], input[type="email"], input[type="password"], select {
      background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); padding: 7px 11px; font-size: 0.83rem; font-family: var(--font);
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    .btn { border: none; border-radius: 6px; padding: 7px 14px; font-size: 0.83rem; font-weight: 600; cursor: pointer; font-family: var(--font); transition: opacity .15s; }
    .btn-primary { background: var(--accent); color: #0d1117; }
    .btn-primary:hover { opacity: .85; }
    .btn-danger { background: rgba(248,81,73,.12); color: var(--red); border: 1px solid rgba(248,81,73,.25); }
    .btn-danger:hover { background: rgba(248,81,73,.22); }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--accent); }
    .btn-report { background: var(--purple); color: #0d1117; font-weight: 700; }
    .btn-report:hover { opacity: .85; }

    /* â”€â”€ Seeds / channels â”€â”€ */
    .seed-item { display: flex; align-items: center; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid var(--border); font-family: var(--mono); font-size: 0.79rem; color: var(--accent); }
    .seed-item:last-child { border-bottom: none; }

    /* â”€â”€ User badges â”€â”€ */
    .badge-admin { background: rgba(248,81,73,.12); color: var(--red); border: 1px solid rgba(248,81,73,.25); border-radius: 4px; padding: 2px 7px; font-size: 0.7rem; font-weight: 600; }
    .badge-user { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); border-radius: 4px; padding: 2px 7px; font-size: 0.7rem; }
    .badge-2fa { background: rgba(63,185,80,.1); color: var(--green); border: 1px solid rgba(63,185,80,.25); border-radius: 4px; padding: 2px 7px; font-size: 0.7rem; }

    /* â”€â”€ Report tab â”€â”€ */
    .report-hero { text-align: center; padding: 60px 20px; }
    .report-hero .icon { font-size: 3rem; margin-bottom: 16px; }
    .report-hero h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 8px; }
    .report-hero p { color: var(--muted); font-size: 0.88rem; margin-bottom: 28px; max-width: 480px; margin-left: auto; margin-right: auto; }
    .report-preview { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 24px; max-width: 560px; margin: 0 auto 28px; text-align: left; }
    .report-preview h3 { font-size: 0.85rem; font-weight: 600; margin-bottom: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; }
    .report-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.84rem; }
    .report-item:last-child { border-bottom: none; }
    .report-item .label { color: var(--muted); }

    /* â”€â”€ Empty â”€â”€ */
    .empty { padding: 50px; text-align: center; color: var(--muted); }
    .empty .icon { font-size: 2.2rem; margin-bottom: 10px; }
    .empty p { font-size: 0.84rem; }

    /* â”€â”€ Toast â”€â”€ */
    #toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 11px 18px; font-size: 0.84rem; opacity: 0; transform: translateY(8px); transition: all .25s; pointer-events: none; z-index: 999; }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.success { border-color: var(--green); color: var(--green); }
    #toast.error { border-color: var(--red); color: var(--red); }

    /* â”€â”€ Settings â”€â”€ */
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px; }
    .section-title { font-size: 0.77rem; font-weight: 600; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); margin-bottom: 14px; }

    /* â”€â”€ Info banner â”€â”€ */
    .info-banner { background: rgba(88,166,255,.06); border: 1px solid rgba(88,166,255,.2); border-radius: 6px; padding: 10px 14px; font-size: 0.8rem; color: var(--muted); margin-top: 14px; }
    code { color: var(--accent); background: var(--bg); padding: 1px 5px; border-radius: 3px; font-family: var(--mono); font-size: .85em; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="status-dot" id="statusDot"></div>
    <h1>Threat Intelligence Platform</h1>
    <span class="badge">THREAT INTEL</span>
  </div>
  <nav>
    <button class="nav-tab active" onclick="switchTab('dashboard', this)">ğŸ“Š Dashboard</button>
    <button class="nav-tab" onclick="switchTab('keywords', this)">ğŸ”‘ Keywords</button>
    <button class="nav-tab" onclick="switchTab('seeds', this)">ğŸŒ± Seeds</button>
    <button class="nav-tab admin-only" id="tab-users" onclick="switchTab('users', this)">ğŸ‘¥ Users</button>
    <button class="nav-tab" onclick="switchTab('investigations', this)">ğŸ” Investigations</button>
    <button class="nav-tab" onclick="switchTab('iplookup', this)">ğŸ” IP Lookup</button>
    <button class="nav-tab" onclick="switchTab('ransomware', this)">â˜ ï¸ Ransomware</button>
    <button class="nav-tab" onclick="switchTab('threatactors', this)">ğŸ•µï¸ Threat Actors</button>
    <button class="nav-tab" onclick="switchTab('dns', this)">ğŸŒ DNS</button>
    <button class="nav-tab" onclick="switchTab('reports', this)">ğŸ“„ Reports</button>
    <button class="nav-tab" onclick="switchTab('settings', this)">âš™ï¸ Settings</button>
  </nav>
  <div class="header-right">
    <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle light/dark mode">ğŸŒ™</button>
    <button class="btn-crawl" id="crawlBtn" onclick="toggleCrawl()">â–¶ Start Crawl</button>
    <span class="user-pill">{{ username }}</span>
    <a href="/logout" class="sign-out">Sign out</a>
  </div>
</header>

<main>

  <!-- â”€â”€ Dashboard Tab â”€â”€ -->
  <div class="tab-panel active" id="panel-dashboard">

    <!-- Live crawl card -->
    <div class="crawl-card" id="crawlCard">
      <div class="crawl-dot" id="crawlDot"></div>
      <div class="crawl-info">
        <div class="crawl-title" id="crawlTitle">No active crawl</div>
        <div class="crawl-sub" id="crawlSub">Click â–¶ Start Crawl to begin scanning</div>
      </div>
      <div class="crawl-stats" id="crawlLiveStats" style="display:none">
        <div class="crawl-stat"><div class="val" id="livePagesVal">0</div><div class="lbl">PAGES</div></div>
        <div class="crawl-stat"><div class="val" id="liveHitsVal">0</div><div class="lbl">HITS</div></div>
      </div>
      <button id="crawlStopBtn" onclick="stopCrawl()" style="display:none;background:rgba(248,81,73,.12);border:1px solid var(--red);color:var(--red);padding:7px 18px;font-family:var(--mono);font-size:11px;letter-spacing:.08em;cursor:pointer;transition:background .2s;flex-shrink:0">â–  STOP</button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card"><div class="lbl">Crawl Sessions</div><div class="val" id="statSessions">â€”</div></div>
      <div class="stat-card"><div class="lbl">Pages Crawled</div><div class="val" id="statPages">â€”</div></div>
      <div class="stat-card"><div class="lbl">Keyword Hits</div><div class="val" id="statHits">â€”</div></div>
    </div>

    <!-- Top keywords -->
    <div class="panel">
      <div class="panel-header"><h2>Top Keywords</h2></div>
      <div class="kw-pills" id="topKeywords"><span style="color:var(--muted);font-size:.84rem">Loadingâ€¦</span></div>
    </div>

    <!-- Session history with expandable hits -->
    <div class="panel">
      <div class="panel-header">
        <h2>Scan Sessions</h2>
        <button class="btn btn-secondary" onclick="loadSessions()">â†» Refresh</button>
      </div>
      <div id="sessionsContainer"><div class="empty"><div class="icon">ğŸ”</div><p>Loadingâ€¦</p></div></div>
    </div>

  </div>

  <!-- â”€â”€ Keywords Tab â”€â”€ -->
  <div class="tab-panel" id="panel-keywords">
    <div class="panel">
      <div class="panel-header"><h2>Manage Keywords</h2></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group"><label>Keyword</label><input type="text" id="newKeyword" style="width:260px" placeholder="e.g. credential dump"/></div>
          <div class="form-group">
            <label>Category</label>
            <select id="newCategory" style="width:170px">
              <option value="custom">custom</option>
              <option value="threat_intel">threat_intel</option>
              <option value="brand_monitoring">brand_monitoring</option>
              <option value="infrastructure">infrastructure</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addKeyword()">+ Add</button>
        </div>
        <div style="margin:14px 0 4px">
          <input type="text" id="keywordSearch" placeholder="ğŸ” Search keywordsâ€¦" oninput="filterKeywords()"
            style="width:100%;max-width:340px;padding:7px 12px;background:var(--surface);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:12px;outline:none"
            onfocus="this.style.borderColor='var(--cyan)'" onblur="this.style.borderColor='var(--border2)'"/>
        </div>
        <div id="keywordsList"><div class="empty"><div class="icon">ğŸ”‘</div><p>Loadingâ€¦</p></div></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Seeds Tab â”€â”€ -->
  <div class="tab-panel" id="panel-seeds">
    <div class="panel">
      <div class="panel-header"><h2>ğŸ§… Dark Web Seeds</h2><span style="color:var(--muted);font-size:.79rem">.onion URLs to crawl</span></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group"><label>Seed URL</label><input type="text" id="newSeed" style="width:400px" placeholder="http://example.onion"/></div>
          <button class="btn btn-primary" onclick="addSeed()">+ Add Seed</button>
        </div>
        <div id="seedsList"><div class="empty"><div class="icon">ğŸŒ±</div><p>Loadingâ€¦</p></div></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><h2>ğŸ“± Telegram Channels</h2><span style="color:var(--muted);font-size:.79rem">Public channels to scrape</span></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group"><label>Channel (without @)</label><input type="text" id="newChannel" style="width:260px" placeholder="channelname"/></div>
          <button class="btn btn-primary" onclick="addChannel()">+ Add Channel</button>
        </div>
        <div id="channelsList"><div class="empty"><div class="icon">ğŸ“±</div><p>Loadingâ€¦</p></div></div>
        <div class="info-banner">Run <code>make telegram-scan</code> on the server to scrape channels. First-time setup: <code>make telegram-auth</code></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Users Tab â”€â”€ -->
  <div class="tab-panel" id="panel-users">
    <div class="panel">
      <div class="panel-header"><h2>User Management</h2></div>
      <div class="panel-body">
        <div class="form-row" style="background:var(--surface2);padding:14px;border-radius:8px;border:1px solid var(--border)">
          <div class="form-group"><label>Username</label><input type="text" id="newUsername" placeholder="username"/></div>
          <div class="form-group"><label>Email</label><input type="email" id="newEmail" placeholder="optional"/></div>
          <div class="form-group"><label>Password</label><input type="password" id="newUserPassword" placeholder="Min 10 chars"/></div>
          <div class="form-group"><label>Role</label><select id="newUserRole" style="width:110px"><option value="0">User</option><option value="1">Admin</option></select></div>
          <button class="btn btn-primary" onclick="createUser()">+ Create</button>
        </div>
        <div id="usersList" style="margin-top:18px"><div class="empty"><div class="icon">ğŸ‘¥</div><p>Loadingâ€¦</p></div></div>
      </div>
    </div>
  </div>


  <!-- â”€â”€ Investigations Tab â”€â”€ -->
  <div class="tab-panel" id="panel-investigations">

    <!-- Create new investigation -->
    <div class="panel" style="margin-bottom:20px">
      <div class="panel-header"><h2>ğŸ” New Investigation</h2><span style="color:var(--muted);font-size:.79rem">Ad hoc targeted lookup</span></div>
      <div class="panel-body">
        <div class="form-group" style="margin-bottom:14px">
          <label>Investigation Name</label>
          <input type="text" id="invName" style="width:360px" placeholder="e.g. Subject Name, Incident 2026-02"/>
        </div>

        <div style="margin-bottom:14px">
          <div class="section-title">Targets</div>
          <div id="invTargets" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-secondary" onclick="addTarget('email')">+ Email</button>
            <button class="btn btn-secondary" onclick="addTarget('name')">+ Name</button>
            <button class="btn btn-secondary" onclick="addTarget('keyword')">+ Keyword</button>
          </div>
        </div>

        <div class="info-banner" style="margin-bottom:14px">
          ğŸ“§ Emails will be checked against HIBP breach database (requires <code>HIBP_API_KEY</code> in .env) and searched in your dark web hits.<br/>
          ğŸ‘¤ Names and keywords will be searched across all captured dark web context.
        </div>

        <button class="btn btn-primary" onclick="runInvestigation()" id="invRunBtn" style="padding:8px 20px">
          â–¶ Run Investigation
        </button>
      </div>
    </div>

    <!-- Investigations list -->
    <div class="panel">
      <div class="panel-header">
        <h2>Past Investigations</h2>
        <button class="btn btn-secondary" onclick="loadInvestigations()">â†» Refresh</button>
      </div>
      <div id="investigationsList"><div class="empty"><div class="icon">ğŸ”</div><p>No investigations yet.</p></div></div>
    </div>

  </div>


  <!-- â”€â”€ IP Lookup Tab â”€â”€ -->
  <div class="tab-panel" id="panel-iplookup">

    <!-- Lookup form -->
    <div class="panel" style="margin-bottom:20px">
      <div class="panel-header">
        <h2>ğŸŒ IP Address Lookup</h2>
        <span style="color:var(--muted);font-size:.79rem">AbuseIPDB + VirusTotal enrichment</span>
      </div>
      <div class="panel-body">
        <div class="form-row" style="align-items:flex-end">
          <div class="form-group">
            <label>IP Address</label>
            <input type="text" id="ipInput" style="width:220px;font-family:var(--mono)" placeholder="e.g. 185.220.101.5" onkeydown="if(event.key==='Enter')runIPLookup()"/>
          </div>
          <button class="btn btn-primary" onclick="runIPLookup()" id="ipLookupBtn" style="padding:8px 20px">ğŸ” Investigate</button>
        </div>
        <div class="info-banner" style="margin-top:12px">
          Requires <code>ABUSEIPDB_API_KEY</code> and/or <code>VIRUSTOTAL_API_KEY</code> in .env â€” both free to get.<br/>
          âš  VirusTotal free tier: 4 requests/min â€” lookup takes ~35s due to rate limiting.
        </div>
        <!-- Inline result -->
        <div id="ipLookupResult" style="margin-top:18px;display:none"></div>
      </div>
    </div>

    <!-- Past IP lookups -->
    <div class="panel">
      <div class="panel-header">
        <h2>Past IP Lookups</h2>
        <button class="btn btn-secondary" onclick="loadIPInvestigations()">â†» Refresh</button>
      </div>
      <div id="ipInvestigationsList">
        <div class="empty"><div class="icon">ğŸŒ</div><p>No IP lookups yet.</p></div>
      </div>
    </div>

  </div>

  <!-- â”€â”€ Ransomware Tracker Tab â”€â”€ -->
  <div class="tab-panel" id="panel-ransomware">
    <div class="intel-filter-bar">
      <input class="intel-search" id="rwSearch" placeholder="ğŸ” Search groupsâ€¦" oninput="filterRansomware()"/>
      <button class="intel-filter-btn active" onclick="filterRwRisk('all', this)">All</button>
      <button class="intel-filter-btn" onclick="filterRwRisk('critical', this)">ğŸ”´ Critical</button>
      <button class="intel-filter-btn" onclick="filterRwRisk('high', this)">ğŸŸ  High</button>
      <button class="intel-filter-btn" onclick="filterRwRisk('sea', this)">ğŸŒ SEA Active</button>
      <button class="intel-filter-btn" onclick="filterRwRisk('hits', this)">âš¡ Has Hits</button>
      <button class="btn btn-secondary" style="margin-left:auto" onclick="addRansomwareSeeds()">+ Add .onion Seeds</button>
      <button class="btn btn-secondary" onclick="addRansomwareKeywords()">+ Add Keywords</button>
    </div>
    <div class="intel-grid" id="ransomwareGrid">
      <div class="empty"><div class="icon">â˜ ï¸</div><p>Loading ransomware intelligenceâ€¦</p></div>
    </div>
  </div>

  <!-- â”€â”€ Threat Actors Tab â”€â”€ -->
  <div class="tab-panel" id="panel-threatactors">
    <div class="intel-filter-bar">
      <input class="intel-search" id="taSearch" placeholder="ğŸ” Search actorsâ€¦" oninput="filterThreatActors()"/>
      <button class="intel-filter-btn active" onclick="filterTaType('all', this)">All</button>
      <button class="intel-filter-btn" onclick="filterTaType('nation-state', this)">ğŸ´ Nation-State</button>
      <button class="intel-filter-btn" onclick="filterTaType('cybercriminal', this)">ğŸ’° Criminal</button>
      <button class="intel-filter-btn" onclick="filterTaType('hacktivist', this)">âœŠ Hacktivist</button>
      <button class="intel-filter-btn" onclick="filterTaType('sea', this)">ğŸŒ SEA Active</button>
      <button class="intel-filter-btn" onclick="filterTaType('hits', this)">âš¡ Has Hits</button>
    </div>
    <div class="intel-grid" id="threatActorsGrid">
      <div class="empty"><div class="icon">ğŸ•µï¸</div><p>Loading threat actor profilesâ€¦</p></div>
    </div>
  </div>

  <!-- â”€â”€ DNS Crawler Tab â”€â”€ -->
  <div class="tab-panel" id="panel-dns">
    <div class="dns-input-bar">
      <input class="dns-input" id="dnsInput" placeholder="example.com" onkeydown="if(event.key==='Enter')startDNS()"/>
      <button class="btn btn-primary" onclick="startDNS()" id="dnsBtn">ğŸ” Investigate</button>
      <button class="btn btn-secondary" onclick="showDNSHistory()" id="dnsHistoryBtn">ğŸ“‹ History</button>
    </div>
    <div id="dnsContent">
      <div class="empty"><div class="icon">ğŸŒ</div><p>Enter a domain to start DNS reconnaissance</p></div>
    </div>
  </div>

  <!-- â”€â”€ Reports Tab â”€â”€ -->
  <div class="tab-panel" id="panel-reports">
    <div class="report-hero">
      <div class="icon">ğŸ“„</div>
      <h2>Executive Report</h2>
      <p>Generate a professional PDF threat intelligence report. Choose a specific scan session or generate an all-time summary.</p>

      <div class="report-preview" style="max-width:560px;margin:0 auto 20px">
        <h3>Scope</h3>
        <div class="report-item">
          <span class="label">Coverage</span>
          <select id="reportScope" style="background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:5px;font-size:.83rem" onchange="updateReportPreview()">
            <option value="all">All sessions (full history)</option>
          </select>
        </div>
        <div class="report-item"><span class="label">Executive Summary</span><span>Stats overview</span></div>
        <div class="report-item"><span class="label">Top Keywords</span><span>By hit count</span></div>
        <div class="report-item"><span class="label">Keyword Hits</span><span id="reportHitsLabel">Latest 200 hits</span></div>
        <div class="report-item"><span class="label">Session History</span><span id="reportSessionsLabel">All sessions</span></div>
      </div>

      <div id="reportStats" style="color:var(--muted);font-size:.84rem;margin-bottom:20px">Loading statsâ€¦</div>

      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-report" onclick="downloadReport()" style="padding:12px 32px;font-size:1rem">
          â¬‡ Download PDF Report
        </button>
        <button class="btn btn-report" onclick="downloadDigest()" style="padding:12px 32px;font-size:1rem;background:var(--surface);border:1px solid var(--border);color:var(--text)">
          ğŸ“‹ Preview Daily Digest
        </button>
      </div>
    </div>

    <!-- Digest mailing list -->
    <div class="panel" style="max-width:680px;margin:0 auto 24px">
      <div class="panel-header">
        <h2>ğŸ“¬ Daily Digest â€” Mailing List</h2>
        <button class="btn btn-primary" onclick="sendDigestNow()" id="digestSendBtn">â–¶ Send Now</button>
      </div>
      <div class="panel-body">
        <p style="color:var(--muted);font-size:.82rem;margin-bottom:14px">
          Sends the daily threat intelligence digest PDF to all subscribers via Mailgun (<code>intel.osintph.info</code>).
        </p>
        <div class="form-row" style="margin-bottom:14px">
          <input type="email" id="newSubscriberEmail" placeholder="subscriber@example.com" style="flex:1;padding:7px 12px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:5px;font-family:var(--mono);font-size:.82rem"/>
          <button class="btn btn-secondary" onclick="addSubscriber()">+ Add</button>
        </div>
        <div id="subscribersList"><p style="color:var(--muted);font-size:.83rem">Loading subscribersâ€¦</p></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Settings Tab â”€â”€ -->
  <div class="tab-panel" id="panel-settings">
    <div class="settings-grid">
      <div class="panel">
        <div class="panel-header"><h2>Change Password</h2></div>
        <div class="panel-body">
          <div class="form-group" style="margin-bottom:10px"><label>Current Password</label><input type="password" id="currentPw" style="width:100%"/></div>
          <div class="form-group" style="margin-bottom:10px"><label>New Password</label><input type="password" id="newPw" style="width:100%"/></div>
          <div class="form-group" style="margin-bottom:14px"><label>Confirm New Password</label><input type="password" id="confirmPw" style="width:100%"/></div>
          <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><h2>Two-Factor Authentication</h2></div>
        <div class="panel-body" id="totpStatus"><p style="color:var(--muted);font-size:.84rem">Loadingâ€¦</p></div>
      </div>
      <div class="panel">
        <div class="panel-header"><h2>Account Info</h2></div>
        <div class="panel-body" id="profileInfo"><p style="color:var(--muted);font-size:.84rem">Loadingâ€¦</p></div>
      </div>
    </div>
  </div>

</main>

<div id="toast"></div>

<script>
  let isAdmin = {{ 'true' if is_admin else 'false' }};
  let crawlActive = false;

  document.addEventListener('DOMContentLoaded', () => {
    if (isAdmin) document.getElementById('tab-users').classList.add('visible');
    fetchStats();
    loadSessions();
    pollCrawlStatus();
    setInterval(() => { fetchStats(); if (crawlActive) loadSessions(); }, 15000);
    setInterval(pollCrawlStatus, 5000);
  });

  function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function fmtTime(iso) {
    if (!iso) return 'â€”';
    try {
      const d = new Date(iso.includes('T') ? (iso.endsWith('Z') ? iso : iso + 'Z') : iso);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    } catch(e) { return iso; }
  }
  function toast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show ' + type;
    setTimeout(() => t.className = '', 3000);
  }

  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchTab(tab, btn) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('panel-' + tab).classList.add('active');
    btn.classList.add('active');
    if (tab === 'keywords') loadKeywords();
    if (tab === 'seeds') { loadSeeds(); loadChannels(); }
    if (tab === 'users' && isAdmin) loadUsers();
    if (tab === 'investigations') loadInvestigations();
    if (tab === 'iplookup') loadIPInvestigations();
    if (tab === 'ransomware') loadRansomware();
    if (tab === 'threatactors') loadThreatActors();
    if (tab === 'dns') loadDNSInvestigations();
    if (tab === 'reports') { loadReportPreview(); if (isAdmin) loadSubscribers(); }
    if (tab === 'settings') loadSettings();
  }

  // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchStats() {
    try {
      const data = await (await fetch('/api/stats')).json();
      document.getElementById('statSessions').textContent = (data.total_sessions||0).toLocaleString();
      document.getElementById('statPages').textContent = (data.total_pages||0).toLocaleString();
      document.getElementById('statHits').textContent = (data.total_hits||0).toLocaleString();
      const el = document.getElementById('topKeywords');
      if (!data.top_keywords?.length) {
        el.innerHTML = '<span style="color:var(--muted);font-size:.84rem;padding:4px">No hits yet.</span>';
      } else {
        el.innerHTML = data.top_keywords.map(k =>
          `<div class="kw-pill" onclick="filterSession('${esc(k.keyword)}')">${esc(k.keyword)}<span class="count">${k.count}</span></div>`
        ).join('');
      }
    } catch(e) { document.getElementById('statusDot').style.background='var(--red)'; }
  }

  // â”€â”€ Crawl status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function pollCrawlStatus() {
    try {
      const data = await (await fetch('/api/crawl/status')).json();
      crawlActive = data.active;
      const card = document.getElementById('crawlCard');
      const dot = document.getElementById('crawlDot');
      const title = document.getElementById('crawlTitle');
      const sub = document.getElementById('crawlSub');
      const liveStats = document.getElementById('crawlLiveStats');
      const btn = document.getElementById('crawlBtn');

      if (data.active && data.session) {
        card.className = 'crawl-card active';
        dot.className = 'crawl-dot pulse';
        title.textContent = 'Crawl in progress';
        sub.innerHTML = `Session #${data.session.id} â€” started ${fmtTime(data.session.started_at)}`;
        liveStats.style.display = 'flex';
        document.getElementById('livePagesVal').textContent = (data.session.pages_crawled||0).toLocaleString();
        document.getElementById('liveHitsVal').textContent = (data.session.hits_found||0).toLocaleString();
        btn.className = 'btn-crawl running';
        btn.textContent = 'â¹ Runningâ€¦';
        btn.disabled = true;
        document.getElementById('crawlStopBtn').style.display = 'inline-block';
      } else {
        card.className = 'crawl-card';
        dot.className = 'crawl-dot';
        title.textContent = 'No active crawl';
        sub.innerHTML = 'Click â–¶ Start Crawl to begin scanning';
        liveStats.style.display = 'none';
        btn.className = 'btn-crawl';
        btn.textContent = 'â–¶ Start Crawl';
        btn.disabled = false;
        document.getElementById('crawlStopBtn').style.display = 'none';
      }
    } catch(e) {}
  }

  async function toggleCrawl() {
    const btn = document.getElementById('crawlBtn');
    const isRunning = btn.classList.contains('running');

    if (isRunning) {
      // Stop crawl
      btn.disabled = true;
      btn.textContent = 'â³ Stoppingâ€¦';
      try {
        const res = await fetch('/api/crawl/stop', { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          toast('Stop signal sent â€” crawl will halt after current page.');
        } else {
          toast(data.error || 'Failed to stop crawl', 'error');
        }
      } catch(e) {
        toast('Network error', 'error');
      } finally {
        btn.disabled = false;
      }
    } else {
      // Start crawl
      btn.disabled = true;
      btn.textContent = 'â³ Startingâ€¦';
      try {
        const res = await fetch('/api/crawl/start', { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          toast('Crawl started.');
          btn.className = 'btn-crawl running';
          btn.textContent = 'â¹ Stop Crawl';
          pollStatus();
        } else {
          toast(data.error || 'Failed to start crawl', 'error');
          btn.textContent = 'â–¶ Start Crawl';
        }
      } catch(e) {
        toast('Network error', 'error');
        btn.textContent = 'â–¶ Start Crawl';
      } finally {
        btn.disabled = false;
      }
    }
  }

  function toggleTheme() {
    const light = document.body.classList.toggle('light');
    document.getElementById('themeBtn').textContent = light ? 'ğŸŒ‘' : 'ğŸŒ™';
    localStorage.setItem('theme', light ? 'light' : 'dark');
  }
  if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light');
    const b = document.getElementById('themeBtn');
    if (b) b.textContent = 'ğŸŒ‘';
  }

  // â”€â”€ Sessions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let expandedSessions = new Set();

  async function loadSessions() {
    const el = document.getElementById('sessionsContainer');
    try {
      const sessions = await (await fetch('/api/sessions')).json();
      if (!sessions.length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸ“‹</div><p>No crawl sessions yet. Click â–¶ Start Crawl above to begin.</p></div>';
        return;
      }
      el.innerHTML = `<table>
        <thead><tr><th>Session</th><th>Started</th><th>Duration</th><th>Pages</th><th>Hits</th><th>Status</th></tr></thead>
        <tbody id="sessionRows">${sessions.map(s => buildSessionRow(s)).join('')}</tbody>
      </table>`;
      // Re-expand previously expanded sessions
      expandedSessions.forEach(id => expandSession(id, false));
    } catch(e) {
      el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading sessions.</div>';
    }
  }

  function buildSessionRow(s) {
    const started = fmtTime(s.started_at);
    const statusClass = `status-${s.status || 'completed'}`;
    let duration = 'â€”';
    if (s.started_at && s.ended_at) {
      const secs = Math.round((new Date(s.ended_at.endsWith('Z')?s.ended_at:s.ended_at+'Z') - new Date(s.started_at.endsWith('Z')?s.started_at:s.started_at+'Z')) / 1000);
      duration = secs < 60 ? `${secs}s` : `${Math.floor(secs/60)}m ${secs%60}s`;
    } else if (s.status === 'running') {
      duration = 'Runningâ€¦';
    }
    return `
      <tr class="session-row" onclick="expandSession(${s.id}, true)" id="sess-${s.id}">
        <td style="font-family:var(--mono);font-size:.8rem;color:var(--muted)">#${s.id}</td>
        <td class="time-cell">${started}</td>
        <td class="time-cell">${duration}</td>
        <td><strong>${(s.pages_crawled||0).toLocaleString()}</strong></td>
        <td><strong style="color:${s.hits_found>0?'var(--accent)':'var(--muted)'}">${(s.hits_found||0).toLocaleString()}</strong></td>
        <td><span class="status-badge ${statusClass}">${s.status||'completed'}</span></td>
      </tr>
      <tr class="session-detail" id="sess-detail-${s.id}">
        <td colspan="6"><div class="session-detail-inner" id="sess-inner-${s.id}">Loadingâ€¦</div></td>
      </tr>`;
  }

  async function expandSession(id, toggle) {
    const detailRow = document.getElementById(`sess-detail-${id}`);
    if (!detailRow) return;
    const isOpen = detailRow.style.display === 'table-row';
    if (toggle && isOpen) {
      detailRow.style.display = 'none';
      expandedSessions.delete(id);
      return;
    }
    detailRow.style.display = 'table-row';
    expandedSessions.add(id);
    const inner = document.getElementById(`sess-inner-${id}`);
    inner.innerHTML = 'Loading hitsâ€¦';
    try {
      const hits = await (await fetch(`/api/sessions/${id}/hits`)).json();
      if (!hits.length) { inner.innerHTML = '<p style="color:var(--muted);font-size:.83rem;padding:8px 0">No keyword hits in this session.</p>'; return; }
      inner.innerHTML = `<table style="margin:8px 0">
        <thead><tr><th>Keyword</th><th>Category</th><th>URL</th><th>Context</th><th>Found At</th></tr></thead>
        <tbody>${hits.map(h => `<tr>
          <td><span class="keyword-tag">${esc(h.keyword)}</span></td>
          <td><span class="cat-tag">${esc(h.category)}</span></td>
          <td class="url-cell">${esc(h.url)}</td>
          <td class="ctx-cell">${esc((h.context||'').slice(0,200))}</td>
          <td class="time-cell">${fmtTime(h.found_at)}</td>
        </tr>`).join('')}</tbody>
      </table>`;
    } catch(e) { inner.innerHTML = '<p style="color:var(--red)">Error loading hits.</p>'; }
  }

  function filterSession(kw) { /* future: filter sessions by keyword */ }

  // â”€â”€ Keywords â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadKeywords() {
    const el = document.getElementById('keywordsList');
    try {
      const data = await (await fetch('/api/keywords')).json();
      const cats = data.categories || {};
      if (!Object.keys(cats).length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸ”‘</div><p>No keywords yet.</p></div>';
        return;
      }
      el.innerHTML = Object.entries(cats).map(([cat, kws]) => `
        <div class="kw-category" data-cat="${esc(cat).toLowerCase()}" style="margin-bottom:18px">
          <div class="section-title">${esc(cat)}</div>
          <table><thead><tr><th>Keyword</th><th style="width:80px">Action</th></tr></thead>
          <tbody>${(kws||[]).map(kw => `<tr class="kw-row" data-kw="${esc(kw).toLowerCase()}">
            <td><span class="keyword-tag">${esc(kw)}</span></td>
            <td><button class="btn btn-danger" onclick="deleteKeyword('${esc(kw).replace(/'/g,"\\'")}','${esc(cat).replace(/'/g,"\\'")}')">Remove</button></td>
          </tr>`).join('')}</tbody></table>
        </div>`).join('');
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error.</div>'; }
  }

  async function addKeyword() {
    const kw = document.getElementById('newKeyword').value.trim();
    const cat = document.getElementById('newCategory').value;
    if (!kw) { toast('Enter a keyword first', 'error'); return; }
    const res = await fetch('/api/keywords', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({keyword:kw,category:cat}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newKeyword').value=''; toast('Keyword added!'); loadKeywords(); }
    else toast(data.error||'Error', 'error');
  }

  async function deleteKeyword(kw, cat) {
    const res = await fetch('/api/keywords', { method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({keyword:kw,category:cat}) });
    const data = await res.json();
    if (data.ok) { toast('Removed'); loadKeywords(); }
    else toast(data.error||'Error','error');
  }

  // â”€â”€ Seeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSeeds() {
    const el = document.getElementById('seedsList');
    try {
      const data = await (await fetch('/api/seeds')).json();
      if (!data.seeds?.length) { el.innerHTML = '<div class="empty"><div class="icon">ğŸŒ±</div><p>No seeds yet.</p></div>'; return; }
      el.innerHTML = data.seeds.map(s => `
        <div class="seed-item">
          <span>${esc(s)}</span>
          <button class="btn btn-danger" onclick="deleteSeed('${esc(s).replace(/'/g,"\\'")}')">Remove</button>
        </div>`).join('');
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error.</div>'; }
  }

  async function addSeed() {
    const url = document.getElementById('newSeed').value.trim();
    if (!url) { toast('Enter a URL', 'error'); return; }
    const res = await fetch('/api/seeds', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newSeed').value=''; toast('Seed added!'); loadSeeds(); }
    else toast(data.error||'Error','error');
  }

  async function deleteSeed(url) {
    const res = await fetch('/api/seeds', { method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url}) });
    const data = await res.json();
    if (data.ok) { toast('Removed'); loadSeeds(); }
    else toast(data.error||'Error','error');
  }

  // â”€â”€ Telegram Channels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadChannels() {
    const el = document.getElementById('channelsList');
    if (!el) return;
    try {
      const data = await (await fetch('/api/telegram/channels')).json();
      if (!data.channels?.length) { el.innerHTML = '<div class="empty"><div class="icon">ğŸ“±</div><p>No channels yet.</p></div>'; return; }
      el.innerHTML = data.channels.map(ch => `
        <div class="seed-item">
          <span>@${esc(ch)}</span>
          <button class="btn btn-danger" onclick="deleteChannel('${esc(ch)}')">Remove</button>
        </div>`).join('');
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--muted)">Configure TELEGRAM_API_ID in .env</div>'; }
  }

  async function addChannel() {
    const ch = document.getElementById('newChannel').value.trim().replace(/^@/,'');
    if (!ch) { toast('Enter a channel username', 'error'); return; }
    const res = await fetch('/api/telegram/channels', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({channel:ch}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newChannel').value=''; toast('Channel added!'); loadChannels(); }
    else toast(data.error||'Error','error');
  }

  async function deleteChannel(ch) {
    const res = await fetch('/api/telegram/channels', { method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({channel:ch}) });
    const data = await res.json();
    if (data.ok) { toast('Removed'); loadChannels(); }
    else toast(data.error||'Error','error');
  }

  // â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadUsers() {
    const el = document.getElementById('usersList');
    try {
      const users = await (await fetch('/api/users')).json();
      if (!users.length) { el.innerHTML = '<div class="empty"><p>No users.</p></div>'; return; }
      el.innerHTML = `<table>
        <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>2FA</th><th>Last Login</th><th></th></tr></thead>
        <tbody>${users.map(u => `<tr>
          <td><strong>${esc(u.username)}</strong></td>
          <td style="color:var(--muted)">${esc(u.email||'â€”')}</td>
          <td>${u.is_admin?'<span class="badge-admin">Admin</span>':'<span class="badge-user">User</span>'}</td>
          <td>${u.totp_enabled?'<span class="badge-2fa">âœ“</span>':'<span style="color:var(--muted);font-size:.79rem">Off</span>'}</td>
          <td class="time-cell">${fmtTime(u.last_login)}</td>
          <td><button class="btn btn-danger" onclick="deleteUser(${u.id},'${esc(u.username)}')">Remove</button></td>
        </tr>`).join('')}</tbody></table>`;
    } catch(e) { el.innerHTML = '<div class="empty" style="color:var(--red)">Error.</div>'; }
  }

  async function createUser() {
    const username = document.getElementById('newUsername').value.trim();
    const email = document.getElementById('newEmail').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const is_admin = document.getElementById('newUserRole').value === '1';
    if (!username || !password) { toast('Username and password required', 'error'); return; }
    const res = await fetch('/api/users', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,email,password,is_admin}) });
    const data = await res.json();
    if (data.ok) { document.getElementById('newUsername').value=''; document.getElementById('newEmail').value=''; document.getElementById('newUserPassword').value=''; toast('User created!'); loadUsers(); }
    else toast(data.error||'Error','error');
  }

  async function deleteUser(id, username) {
    if (!confirm(`Remove "${username}"?`)) return;
    const res = await fetch(`/api/users/${id}`, { method:'DELETE' });
    const data = await res.json();
    if (data.ok) { toast('Removed'); loadUsers(); }
    else toast(data.error||'Error','error');
  }

  // â”€â”€ Reports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let reportSessions = [];

  async function loadReportPreview() {
    try {
      const [stats, sessions] = await Promise.all([
        (await fetch('/api/stats')).json(),
        (await fetch('/api/sessions')).json(),
      ]);
      reportSessions = sessions;
      document.getElementById('reportStats').innerHTML =
        `<strong>${stats.total_hits}</strong> keyword hits across <strong>${stats.total_sessions}</strong> sessions Â· <strong>${stats.total_pages}</strong> pages crawled`;
      // Populate session dropdown
      const sel = document.getElementById('reportScope');
      sel.innerHTML = '<option value="all">All sessions (full history)</option>';
      sessions.forEach(s => {
        const started = fmtTime(s.started_at);
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `Session #${s.id} â€” ${started} (${s.hits_found} hits, ${s.pages_crawled} pages)`;
        sel.appendChild(opt);
      });
    } catch(e) {}
  }

  function updateReportPreview() {
    const val = document.getElementById('reportScope').value;
    if (val === 'all') {
      document.getElementById('reportHitsLabel').textContent = 'Latest 200 hits';
      document.getElementById('reportSessionsLabel').textContent = 'All sessions';
    } else {
      const s = reportSessions.find(x => x.id == val);
      if (s) {
        document.getElementById('reportHitsLabel').textContent = `${s.hits_found} hits from this session`;
        document.getElementById('reportSessionsLabel').textContent = `Session #${s.id} only`;
      }
    }
  }

  function downloadReport() {
    const btn = document.querySelector('.btn-report');
    btn.textContent = 'â³ Generatingâ€¦';
    btn.disabled = true;
    const scope = document.getElementById('reportScope').value;
    const url = scope === 'all' ? '/api/report/pdf' : `/api/report/pdf?session_id=${scope}`;
    window.location.href = url;
    setTimeout(() => { btn.textContent = 'â¬‡ Download PDF Report'; btn.disabled = false; }, 3000);
  }

  // â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSettings() {
    try {
      const profile = await (await fetch('/api/settings/profile')).json();
      document.getElementById('profileInfo').innerHTML = `
        <div style="display:grid;gap:9px">
          ${[['Username',profile.username],['Email',profile.email||'â€”'],['Role',profile.is_admin?'<span class="badge-admin">Admin</span>':'<span class="badge-user">User</span>'],['OAuth',profile.oauth_provider||'None'],['Last login',fmtTime(profile.last_login)],['Member since',fmtTime(profile.created_at)]].map(([l,v])=>`
          <div style="display:flex;justify-content:space-between;font-size:.84rem"><span style="color:var(--muted)">${l}</span><span>${v}</span></div>`).join('')}
        </div>`;
      const totpEl = document.getElementById('totpStatus');
      if (profile.totp_enabled) {
        totpEl.innerHTML = `<p style="color:var(--green);font-size:.84rem;margin-bottom:14px">âœ“ 2FA is enabled.</p>
          <div class="form-group" style="margin-bottom:10px"><label>TOTP code or password to disable</label><input type="text" id="disableTotpCode" style="width:100%"/></div>
          <button class="btn btn-danger" onclick="disableTotp()">Disable 2FA</button>`;
      } else {
        totpEl.innerHTML = `<p style="color:var(--muted);font-size:.84rem;margin-bottom:14px">2FA is not enabled.</p>
          <a href="/totp/setup" class="btn btn-primary">Set Up 2FA</a>`;
      }
    } catch(e) {}
  }

  async function changePassword() {
    const body = { current_password: document.getElementById('currentPw').value, new_password: document.getElementById('newPw').value, confirm_password: document.getElementById('confirmPw').value };
    const res = await fetch('/api/settings/password', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const data = await res.json();
    if (data.ok) { document.getElementById('currentPw').value=''; document.getElementById('newPw').value=''; document.getElementById('confirmPw').value=''; toast('Password updated!'); }
    else toast(data.error||'Error','error');
  }

  async function disableTotp() {
    const val = document.getElementById('disableTotpCode').value.trim();
    const body = val.length===6 && /^\d+$/.test(val) ? {totp_code:val} : {password:val};
    const res = await fetch('/api/settings/totp/disable', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const data = await res.json();
    if (data.ok) { toast('2FA disabled'); loadSettings(); }
    else toast(data.error||'Invalid code','error');
  }

  // â”€â”€ Investigations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let targetCount = 0;

  function addTarget(type) {
    targetCount++;
    const id = `target-${targetCount}`;
    const labels = { email: 'ğŸ“§ Email', name: 'ğŸ‘¤ Name', keyword: 'ğŸ”‘ Keyword' };
    const placeholders = { email: 'user@example.com', name: 'John Doe', keyword: 'company name' };
    const colors = { email: 'var(--accent)', name: 'var(--green)', keyword: 'var(--purple)' };
    const div = document.createElement('div');
    div.id = id;
    div.style.cssText = 'display:flex;align-items:center;gap:8px';
    div.innerHTML = `
      <span style="font-size:.75rem;font-weight:600;color:${colors[type]};width:62px;flex-shrink:0">${labels[type]}</span>
      <input type="text" data-type="${type}" style="flex:1;max-width:360px" placeholder="${placeholders[type]}"/>
      <button class="btn btn-danger" onclick="document.getElementById('${id}').remove()" style="padding:4px 10px">âœ•</button>`;
    document.getElementById('invTargets').appendChild(div);
    div.querySelector('input').focus();
  }



  let _allKeywords = [];

  function filterKeywords() {
    const q = (document.getElementById('keywordSearch')?.value || '').toLowerCase();
    if (!document.querySelector('#keywordsList .kw-row')) { loadKeywords(); return; }
    if (!q) {
      document.querySelectorAll('#keywordsList .kw-row').forEach(r => r.style.display = '');
      document.querySelectorAll('#keywordsList .kw-category').forEach(c => c.style.display = '');
      return;
    }
    document.querySelectorAll('#keywordsList .kw-category').forEach(cat => {
      let anyVisible = false;
      cat.querySelectorAll('.kw-row').forEach(row => {
        const match = (row.dataset.kw || '').includes(q) || (cat.dataset.cat || '').includes(q);
        row.style.display = match ? '' : 'none';
        if (match) anyVisible = true;
      });
      cat.style.display = anyVisible ? '' : 'none';
    });
  }
  async function stopCrawl() {
    if (!confirm('Send stop signal? The crawl will finish the current page then halt.')) return;
    const btn = document.getElementById('crawlStopBtn');
    btn.textContent = 'â³ Stoppingâ€¦';
    btn.disabled = true;
    try {
      const res = await fetch('/api/crawl/stop', { method: 'POST' });
      const data = await res.json();
      if (data.ok) toast('Stop signal sent â€” crawl will halt shortly.');
      else toast(data.error || 'Error', 'error');
    } catch(e) {
      toast('Network error', 'error');
    } finally {
      btn.textContent = 'â–  Stop Crawl';
      btn.disabled = false;
    }
  }
  async function runInvestigation() {
    const name = document.getElementById('invName').value.trim();
    if (!name) { toast('Enter an investigation name', 'error'); return; }

    const inputs = document.querySelectorAll('#invTargets input');
    const targets = [];
    inputs.forEach(inp => {
      const val = inp.value.trim();
      if (val) targets.push({ value: val, type: inp.dataset.type });
    });

    if (!targets.length) { toast('Add at least one target', 'error'); return; }

    const btn = document.getElementById('invRunBtn');
    btn.textContent = 'â³ Runningâ€¦';
    btn.disabled = true;

    try {
      const res = await fetch('/api/investigations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, targets })
      });
      const data = await res.json();
      if (data.ok) {
        toast(`Investigation complete! ID #${data.id}`);
        document.getElementById('invName').value = '';
        document.getElementById('invTargets').innerHTML = '';
        targetCount = 0;
        loadInvestigations();
      } else {
        toast(data.error || 'Error running investigation', 'error');
      }
    } catch(e) {
      toast('Network error', 'error');
    } finally {
      btn.textContent = 'â–¶ Run Investigation';
      btn.disabled = false;
    }
  }

  async function loadInvestigations() {
    const el = document.getElementById('investigationsList');
    try {
      const invs = await (await fetch('/api/investigations')).json();
      if (!invs.length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸ”</div><p>No investigations yet. Create one above.</p></div>';
        return;
      }
      el.innerHTML = `<table>
        <thead><tr><th>Name</th><th>Targets</th><th>Status</th><th>Created</th><th></th></tr></thead>
        <tbody>${invs.map(inv => `
          <tr class="session-row" onclick="expandInvestigation(${inv.id})" id="inv-${inv.id}">
            <td><strong>${esc(inv.name)}</strong></td>
            <td style="color:var(--muted)">${inv.target_count} target${inv.target_count !== 1 ? 's' : ''}</td>
            <td><span class="status-badge status-${inv.status}">${inv.status}</span></td>
            <td class="time-cell">${fmtTime(inv.created_at)}</td>
            <td><button class="btn btn-danger" onclick="event.stopPropagation();deleteInvestigation(${inv.id})" style="padding:3px 10px">âœ•</button></td>
          </tr>
          <tr class="session-detail" id="inv-detail-${inv.id}">
            <td colspan="5"><div class="session-detail-inner" id="inv-inner-${inv.id}"></div></td>
          </tr>`).join('')}
        </tbody></table>`;
    } catch(e) {
      el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading investigations.</div>';
    }
  }

  async function expandInvestigation(id) {
    const detail = document.getElementById(`inv-detail-${id}`);
    if (!detail) return;
    const isOpen = detail.style.display === 'table-row';
    if (isOpen) { detail.style.display = 'none'; return; }
    detail.style.display = 'table-row';
    const inner = document.getElementById(`inv-inner-${id}`);
    inner.innerHTML = 'Loadingâ€¦';
    try {
      const data = await (await fetch(`/api/investigations/${id}`)).json();
      if (!data.targets?.length) { inner.innerHTML = '<p style="color:var(--muted);padding:10px">No targets found.</p>'; return; }
      inner.innerHTML = data.targets.map(t => buildTargetCard(t)).join('');
    } catch(e) {
      inner.innerHTML = '<p style="color:var(--red)">Error loading results.</p>';
    }
  }

  function buildTargetCard(t) {
    const typeColors = { email: 'var(--accent)', name: 'var(--green)', keyword: 'var(--purple)' };
    const typeIcons = { email: 'ğŸ“§', name: 'ğŸ‘¤', keyword: 'ğŸ”‘' };
    let html = `<div style="border:1px solid var(--border);border-radius:8px;padding:14px;margin:10px 0;background:var(--bg)">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <span style="font-size:1.1rem">${typeIcons[t.target_type] || 'ğŸ¯'}</span>
        <strong style="color:${typeColors[t.target_type] || 'var(--text)'}">${esc(t.value)}</strong>
        <span style="font-size:.72rem;color:var(--muted)">${t.target_type}</span>
        ${t.error ? `<span style="color:var(--yellow);font-size:.75rem">âš  ${esc(t.error)}</span>` : ''}
      </div>`;

    // Breaches
    if (t.target_type === 'email') {
      if (t.breaches?.length) {
        html += `<div style="margin-bottom:12px">
          <div style="color:var(--red);font-weight:600;font-size:.82rem;margin-bottom:8px">âš  Found in ${t.breaches.length} breach(es)</div>
          ${t.breaches.map(b => `
            <div style="background:rgba(248,81,73,.06);border:1px solid rgba(248,81,73,.2);border-radius:6px;padding:10px;margin-bottom:6px">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                <strong style="color:var(--red)">${esc(b.breach_name)}</strong>
                <span style="color:var(--muted);font-size:.75rem">${esc(b.breach_date)}</span>
              </div>
              <div style="font-size:.75rem;color:var(--muted);margin-bottom:5px">${esc(b.description?.replace(/<[^>]+>/g,'').slice(0,200) || '')}</div>
              <div style="display:flex;flex-wrap:wrap;gap:4px">
                ${(b.data_classes||[]).map(dc => `<span style="background:rgba(248,81,73,.1);color:var(--red);border-radius:3px;padding:1px 6px;font-size:.7rem">${esc(dc)}</span>`).join('')}
              </div>
            </div>`).join('')}
        </div>`;
      } else if (!t.error) {
        html += `<div style="color:var(--green);font-size:.82rem;margin-bottom:12px">âœ“ No breaches found in HIBP</div>`;
      }
    }

    // Dark web hits
    if (t.darkweb_hits?.length) {
      html += `<div>
        <div style="color:var(--orange);font-weight:600;font-size:.82rem;margin-bottom:8px">ğŸ•¸ Found in ${t.darkweb_hits.length} dark web hit(s)</div>
        ${t.darkweb_hits.slice(0,5).map(h => `
          <div style="background:rgba(240,136,62,.06);border:1px solid rgba(240,136,62,.2);border-radius:6px;padding:10px;margin-bottom:6px">
            <div style="font-family:var(--mono);font-size:.75rem;color:var(--accent);margin-bottom:4px">${esc(h.url)}</div>
            <div style="font-size:.75rem;color:var(--muted);font-family:var(--mono)">${esc((h.context||'').slice(0,200))}</div>
            <div style="font-size:.7rem;color:var(--muted);margin-top:4px">${esc(h.found_at||'')}</div>
          </div>`).join('')}
        ${t.darkweb_hits.length > 5 ? `<p style="color:var(--muted);font-size:.75rem">â€¦and ${t.darkweb_hits.length - 5} more</p>` : ''}
      </div>`;
    } else {
      html += `<div style="color:var(--muted);font-size:.82rem">No matches in dark web database</div>`;
    }

    html += '</div>';
    return html;
  }

  async function deleteInvestigation(id) {
    if (!confirm('Delete this investigation?')) return;
    const res = await fetch(`/api/investigations/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.ok) { toast('Deleted'); loadInvestigations(); }
    else toast(data.error || 'Error', 'error');
  }


  // â”€â”€ IP Lookup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function runIPLookup() {
    const ip = document.getElementById('ipInput').value.trim();
    if (!ip) { toast('Enter an IP address', 'error'); return; }
    const btn = document.getElementById('ipLookupBtn');
    const resultEl = document.getElementById('ipLookupResult');
    btn.textContent = 'â³ Investigatingâ€¦';
    btn.disabled = true;
    resultEl.style.display = 'none';

    try {
      const res = await fetch('/api/ip-investigations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip })
      });
      const data = await res.json();
      if (!data.ok) { toast(data.error || 'Error', 'error'); return; }

      // Fetch full results and show inline
      const full = await (await fetch(`/api/ip-investigations/${data.id}`)).json();
      resultEl.style.display = 'block';
      resultEl.innerHTML = buildIPReport(full);
      loadIPInvestigations();
      toast(`Lookup complete for ${ip}`);
    } catch(e) {
      toast('Network error', 'error');
    } finally {
      btn.textContent = 'ğŸ” Investigate';
      btn.disabled = false;
    }
  }

  async function loadIPInvestigations() {
    const el = document.getElementById('ipInvestigationsList');
    try {
      const items = await (await fetch('/api/ip-investigations')).json();
      if (!items.length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸŒ</div><p>No IP lookups yet.</p></div>';
        return;
      }
      el.innerHTML = `<table>
        <thead><tr><th>IP Address</th><th>Country</th><th>ISP/AS Owner</th><th>Abuse Score</th><th>VT Malicious</th><th>Looked Up</th><th></th></tr></thead>
        <tbody>${items.map(i => {
          const score = i.abuse_score ?? 'â€”';
          const scoreColor = i.abuse_score >= 80 ? 'var(--red)' : i.abuse_score >= 30 ? 'var(--yellow)' : 'var(--green)';
          const vtColor = i.vt_malicious > 5 ? 'var(--red)' : i.vt_malicious > 0 ? 'var(--yellow)' : 'var(--green)';
          return `<tr class="session-row" onclick="expandIPInvestigation(${i.id})" id="ipinv-${i.id}">
            <td style="font-family:var(--mono);font-weight:600">${esc(i.ip)}</td>
            <td>${esc(i.country || 'â€”')}</td>
            <td style="color:var(--muted);font-size:.8rem">${esc(i.isp || 'â€”')}</td>
            <td><strong style="color:${scoreColor}">${score}%</strong></td>
            <td><strong style="color:${vtColor}">${i.vt_malicious ?? 'â€”'}</strong></td>
            <td class="time-cell">${fmtTime(i.created_at)}</td>
            <td><button class="btn btn-danger" onclick="event.stopPropagation();deleteIPInv(${i.id})" style="padding:3px 10px">âœ•</button></td>
          </tr>
          <tr class="session-detail" id="ipinv-detail-${i.id}">
            <td colspan="7"><div class="session-detail-inner" id="ipinv-inner-${i.id}"></div></td>
          </tr>`;
        }).join('')}</tbody></table>`;
    } catch(e) {
      el.innerHTML = '<div class="empty" style="color:var(--red)">Error loading.</div>';
    }
  }

  async function expandIPInvestigation(id) {
    const detail = document.getElementById(`ipinv-detail-${id}`);
    if (!detail) return;
    if (detail.style.display === 'table-row') { detail.style.display = 'none'; return; }
    detail.style.display = 'table-row';
    const inner = document.getElementById(`ipinv-inner-${id}`);
    inner.innerHTML = 'Loadingâ€¦';
    try {
      const data = await (await fetch(`/api/ip-investigations/${id}`)).json();
      inner.innerHTML = buildIPReport(data);
    } catch(e) { inner.innerHTML = '<p style="color:var(--red)">Error.</p>'; }
  }

  function buildIPReport(data) {
    const a = data.abuseipdb || {};
    const v = data.virustotal || {};
    const aError = a.error;
    const vError = v.error;

    let html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:12px 0">`;

    // â”€â”€ AbuseIPDB Panel â”€â”€
    html += `<div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="font-size:1.1rem">ğŸ›¡</span>
        <strong style="font-size:.9rem">AbuseIPDB</strong>
        ${aError ? `<span style="color:var(--red);font-size:.75rem">âš  ${esc(aError)}</span>` : ''}
      </div>`;

    if (!aError && a.ip) {
      const score = a.abuse_confidence_score ?? 0;
      const scoreColor = score >= 80 ? 'var(--red)' : score >= 30 ? 'var(--yellow)' : 'var(--green)';
      html += `
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:2.8rem;font-weight:800;color:${scoreColor}">${score}%</div>
          <div style="color:var(--muted);font-size:.75rem">Abuse Confidence Score</div>
        </div>
        ${ipRow('IP', a.ip)}
        ${ipRow('Country', (a.country_name || '') + (a.country_code ? ` (${a.country_code})` : ''))}
        ${ipRow('ISP', a.isp)}
        ${ipRow('Domain', a.domain)}
        ${ipRow('Usage Type', a.usage_type)}
        ${ipRow('Tor Exit Node', a.is_tor ? 'âš  YES' : 'No', a.is_tor ? 'color:var(--red)' : '')}
        ${ipRow('Total Reports', a.total_reports + (a.num_distinct_users ? ` (${a.num_distinct_users} reporters)` : ''))}
        ${ipRow('Last Reported', a.last_reported_at ? fmtTime(a.last_reported_at) : 'Never')}
        ${a.hostnames?.length ? ipRow('Hostnames', a.hostnames.slice(0,3).join(', ')) : ''}`;

      if (a.reports?.length) {
        html += `<div style="margin-top:12px">
          <div style="font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:8px">Recent Reports</div>
          ${a.reports.slice(0,5).map(r => `
            <div style="background:var(--surface2);border-radius:5px;padding:8px;margin-bottom:5px;font-size:.76rem">
              <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                <span style="color:var(--red)">${(r.categories||[]).join(', ') || 'Unknown'}</span>
                <span style="color:var(--muted)">${r.reporter_country || ''}</span>
              </div>
              ${r.comment ? `<div style="color:var(--muted);font-family:var(--mono)">${esc(r.comment.slice(0,150))}</div>` : ''}
            </div>`).join('')}
        </div>`;
      }
    }
    html += `</div>`;

    // â”€â”€ VirusTotal Panel â”€â”€
    html += `<div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="font-size:1.1rem">ğŸ¦ </span>
        <strong style="font-size:.9rem">VirusTotal</strong>
        ${vError ? `<span style="color:var(--red);font-size:.75rem">âš  ${esc(vError)}</span>` : ''}
      </div>`;

    if (!vError && v.ip) {
      const stats = v.analysis_stats || {};
      const mal = stats.malicious || 0;
      const sus = stats.suspicious || 0;
      const total = v.total_engines || 0;
      const malColor = mal > 5 ? 'var(--red)' : mal > 0 ? 'var(--yellow)' : 'var(--green)';
      html += `
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:2.8rem;font-weight:800;color:${malColor}">${mal}/${total}</div>
          <div style="color:var(--muted);font-size:.75rem">Malicious Detections</div>
          <div style="font-size:.75rem;color:var(--muted);margin-top:2px">
            ${sus} suspicious Â· ${stats.harmless||0} harmless Â· ${stats.undetected||0} undetected
          </div>
        </div>
        ${ipRow('ASN', v.asn ? `AS${v.asn} â€” ${v.as_owner||''}` : 'â€”')}
        ${ipRow('Country', v.country || 'â€”')}
        ${ipRow('Continent', v.continent || 'â€”')}
        ${ipRow('Network', v.network || 'â€”')}
        ${ipRow('Registry', v.regional_internet_registry || 'â€”')}
        ${ipRow('Reputation', v.reputation !== undefined ? String(v.reputation) : 'â€”')}
        ${ipRow('JARM', v.jarm ? v.jarm.slice(0,24)+'â€¦' : 'â€”')}
        ${v.tags?.length ? ipRow('Tags', v.tags.join(', ')) : ''}
        ${ipRow('Last Analysis', v.last_analysis_date ? fmtTime(v.last_analysis_date) : 'â€”')}`;

      if (v.malicious_engines?.length) {
        html += `<div style="margin-top:12px">
          <div style="font-size:.75rem;font-weight:600;color:var(--red);text-transform:uppercase;margin-bottom:8px">Flagged by ${v.malicious_engines.length} engine(s)</div>
          ${v.malicious_engines.slice(0,8).map(e => `
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:.76rem">
              <span>${esc(e.engine)}</span>
              <span style="color:${e.category==='malicious'?'var(--red)':'var(--yellow)'}">${esc(e.result||e.category)}</span>
            </div>`).join('')}
        </div>`;
      }

      if (v.ssl_certificate) {
        const ssl = v.ssl_certificate;
        html += `<div style="margin-top:12px">
          <div style="font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:8px">SSL Certificate</div>
          ${ssl.subject_cn ? ipRow('Subject CN', ssl.subject_cn) : ''}
          ${ssl.issuer_org ? ipRow('Issuer', ssl.issuer_org) : ''}
          ${ssl.valid_from ? ipRow('Valid', ssl.valid_from + ' â†’ ' + (ssl.valid_to||'?')) : ''}
        </div>`;
      }
    }
    html += `</div></div>`;

    // â”€â”€ Resolutions â”€â”€
    if (v.resolutions?.length) {
      html += `<div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:4px">
        <div style="font-size:.8rem;font-weight:600;margin-bottom:10px">ğŸ“¡ Historical DNS Resolutions (${v.resolutions.length})</div>
        <table style="font-size:.78rem">
          <thead><tr><th>Hostname</th><th>Date</th></tr></thead>
          <tbody>${v.resolutions.slice(0,15).map(r => `<tr>
            <td style="font-family:var(--mono);color:var(--accent)">${esc(r.hostname||'â€”')}</td>
            <td class="time-cell">${r.date ? fmtTime(new Date(r.date*1000).toISOString()) : 'â€”'}</td>
          </tr>`).join('')}</tbody>
        </table>
      </div>`;
    }

    // â”€â”€ Communicating files â”€â”€
    if (v.communicating_files?.length) {
      html += `<div style="background:var(--bg);border:1px solid rgba(248,81,73,.25);border-radius:8px;padding:14px;margin-top:8px">
        <div style="font-size:.8rem;font-weight:600;color:var(--red);margin-bottom:10px">âš  Malware communicating with this IP (${v.communicating_files.length} samples)</div>
        <table style="font-size:.76rem">
          <thead><tr><th>Name</th><th>Type</th><th>SHA256</th><th>Malicious</th></tr></thead>
          <tbody>${v.communicating_files.map(f => `<tr>
            <td style="color:var(--red)">${esc(f.name||'unknown')}</td>
            <td style="color:var(--muted)">${esc(f.type||'â€”')}</td>
            <td style="font-family:var(--mono);font-size:.7rem;color:var(--muted)">${(f.sha256||'').slice(0,16)}â€¦</td>
            <td style="color:${f.malicious>0?'var(--red)':'var(--muted)'}">${f.malicious||0}</td>
          </tr>`).join('')}</tbody>
        </table>
      </div>`;
    }

    // â”€â”€ WHOIS â”€â”€
    if (v.whois) {
      html += `<details style="margin-top:8px">
        <summary style="cursor:pointer;font-size:.8rem;color:var(--muted);padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px">ğŸ“‹ WHOIS Data</summary>
        <pre style="background:var(--bg);border:1px solid var(--border);border-radius:0 0 6px 6px;padding:12px;font-size:.72rem;color:var(--muted);overflow-x:auto;max-height:300px;overflow-y:auto">${esc(v.whois)}</pre>
      </details>`;
    }

    return html;
  }

  function ipRow(label, value, style = '') {
    if (!value || value === 'â€”' || value === 'undefined') return '';
    return `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:.8rem">
      <span style="color:var(--muted)">${label}</span>
      <span style="text-align:right;max-width:60%;word-break:break-all;${style}">${esc(String(value))}</span>
    </div>`;
  }

  async function deleteIPInv(id) {
    if (!confirm('Delete this IP lookup?')) return;
    await fetch(`/api/ip-investigations/${id}`, { method: 'DELETE' });
    toast('Deleted');
    loadIPInvestigations();
  }

  // â”€â”€ Ransomware Tracker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let rwData = [];
  let rwRiskFilter = 'all';

  async function loadRansomware() {
    const grid = document.getElementById('ransomwareGrid');
    grid.innerHTML = '<div class="empty"><div class="icon">â³</div><p>Loading intelligenceâ€¦</p></div>';
    try {
      rwData = await (await fetch('/api/ransomware/groups')).json();
      renderRansomware();
    } catch(e) {
      grid.innerHTML = '<div class="empty"><div class="icon">âš ï¸</div><p>Failed to load.</p></div>';
    }
  }

  function filterRwRisk(risk, btn) {
    rwRiskFilter = risk;
    document.querySelectorAll('#panel-ransomware .intel-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderRansomware();
  }

  function filterRansomware() { renderRansomware(); }

  function renderRansomware() {
    const q = (document.getElementById('rwSearch')?.value || '').toLowerCase();
    let data = rwData.filter(g => {
      if (q && !g.name.toLowerCase().includes(q) && !g.description.toLowerCase().includes(q)) return false;
      if (rwRiskFilter === 'critical') return g.risk_level === 'critical';
      if (rwRiskFilter === 'high') return g.risk_level === 'high';
      if (rwRiskFilter === 'sea') return g.targeting_sea;
      if (rwRiskFilter === 'hits') return g.hit_count > 0;
      return true;
    });
    const grid = document.getElementById('ransomwareGrid');
    if (!data.length) { grid.innerHTML = '<div class="empty"><div class="icon">ğŸ”</div><p>No groups match filter.</p></div>'; return; }
    grid.innerHTML = data.map(g => `
      <div class="intel-card risk-${g.risk_level}">
        <div class="intel-card-header">
          <div>
            <div class="intel-card-name">${esc(g.name)}</div>
            <div class="intel-card-origin">ğŸŒ ${esc(g.origin)} Â· First seen ${esc(g.first_seen)}</div>
          </div>
        </div>
        <div class="intel-badges">
          <span class="intel-badge badge-${g.risk_level}">${g.risk_level.toUpperCase()}</span>
          <span class="intel-badge badge-${g.status}">${g.status.toUpperCase()}</span>
          ${g.targeting_sea ? '<span class="intel-badge badge-sea">ğŸŒ SEA</span>' : ''}
          ${g.sea_victims?.length ? `<span class="intel-badge badge-high">âš  ${g.sea_victims.length} PH/SEA victim${g.sea_victims.length > 1 ? 's' : ''}</span>` : ''}
        </div>
        <div class="intel-desc">${esc(g.description)}</div>
        <div class="intel-ttps">${(g.ttps||[]).map(t => `<span class="ttp-tag">${esc(t)}</span>`).join('')}</div>
        ${g.sea_victims?.length ? `<div style="font-size:.73rem;color:var(--red);margin-bottom:8px">âš  Known victims: ${g.sea_victims.map(v => esc(v)).join(', ')}</div>` : ''}
        <div class="intel-hits">
          <span class="intel-hit-count ${g.hit_count > 0 ? 'has-hits' : ''}">${g.hit_count}</span>
          <span>keyword hits in database</span>
          ${g.recent_hits?.length ? `<button class="btn btn-secondary" style="margin-left:auto;font-size:.7rem;padding:3px 8px" onclick="showRwHits(${JSON.stringify(g.name).replace(/"/g,'&quot;')}, this)">View hits</button>` : ''}
        </div>
        ${g.recent_hits?.length ? `<div class="rw-hits" style="display:none;margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:8px;max-height:160px;overflow-y:auto">
          ${g.recent_hits.map(h => `<div style="font-size:.72rem;padding:4px 0;border-bottom:1px solid var(--border)">
            <span style="color:var(--accent);font-family:var(--mono)">${esc(h.keyword)}</span>
            <span style="color:var(--muted);margin:0 6px">Â·</span>
            <span style="color:var(--muted)">${h.found_at ? new Date(h.found_at+'Z').toLocaleDateString() : 'â€”'}</span>
            <div style="color:var(--muted);font-size:.68rem;margin-top:2px;font-family:var(--mono);word-break:break-all">${esc(h.url)}</div>
          </div>`).join('')}
        </div>` : ''}
      </div>
    `).join('');
  }

  function showRwHits(name, btn) {
    const card = btn.closest('.intel-card');
    const hits = card.querySelector('.rw-hits');
    const open = hits.style.display !== 'none';
    hits.style.display = open ? 'none' : 'block';
    btn.textContent = open ? 'View hits' : 'Hide hits';
  }

  async function addRansomwareSeeds() {
    if (!confirm('Add all known ransomware .onion URLs to your seed list?')) return;
    const res = await fetch('/api/ransomware/add-seeds', { method: 'POST' });
    const d = await res.json();
    if (d.ok) toast(`Added ${d.added} new onion seeds`);
    else toast(d.error || 'Error', 'error');
  }

  async function addRansomwareKeywords() {
    if (!confirm('Add all ransomware group names as keywords to the scanner?')) return;
    const res = await fetch('/api/ransomware/add-keywords', { method: 'POST' });
    const d = await res.json();
    if (d.ok) toast(`Added ${d.added} new ransomware keywords`);
    else toast(d.error || 'Error', 'error');
  }

  // â”€â”€ Threat Actors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let taData = [];
  let taTypeFilter = 'all';

  async function loadThreatActors() {
    const grid = document.getElementById('threatActorsGrid');
    grid.innerHTML = '<div class="empty"><div class="icon">â³</div><p>Loading profilesâ€¦</p></div>';
    try {
      taData = await (await fetch('/api/threat-actors')).json();
      renderThreatActors();
    } catch(e) {
      grid.innerHTML = '<div class="empty"><div class="icon">âš ï¸</div><p>Failed to load.</p></div>';
    }
  }

  function filterTaType(type, btn) {
    taTypeFilter = type;
    document.querySelectorAll('#panel-threatactors .intel-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderThreatActors();
  }

  function filterThreatActors() { renderThreatActors(); }

  function renderThreatActors() {
    const q = (document.getElementById('taSearch')?.value || '').toLowerCase();
    let data = taData.filter(a => {
      if (q && !a.name.toLowerCase().includes(q) && !a.description.toLowerCase().includes(q) && !(a.aliases||[]).join(' ').toLowerCase().includes(q)) return false;
      if (taTypeFilter === 'nation-state') return a.type === 'nation-state';
      if (taTypeFilter === 'cybercriminal') return a.type === 'cybercriminal';
      if (taTypeFilter === 'hacktivist') return a.type === 'hacktivist';
      if (taTypeFilter === 'sea') return a.targeting_sea;
      if (taTypeFilter === 'hits') return a.hit_count > 0;
      return true;
    });
    const grid = document.getElementById('threatActorsGrid');
    if (!data.length) { grid.innerHTML = '<div class="empty"><div class="icon">ğŸ”</div><p>No actors match filter.</p></div>'; return; }
    const typeIcon = { 'nation-state': 'ğŸ´', 'cybercriminal': 'ğŸ’°', 'hacktivist': 'âœŠ' };
    const riskColors = { critical: 'var(--red)', high: 'var(--orange)', medium: 'var(--yellow)' };
    grid.innerHTML = data.map(a => `
      <div class="intel-card risk-${a.risk_level}">
        <div class="intel-card-header">
          <div>
            <div class="intel-card-name">${esc(a.name)}</div>
            <div class="intel-card-origin">ğŸŒ ${esc(a.origin)} Â· ${typeIcon[a.type] || 'ğŸ‘¤'} ${esc(a.type)} Â· Since ${esc(a.first_seen)}</div>
          </div>
        </div>
        <div class="intel-badges">
          <span class="intel-badge badge-${a.risk_level}">${a.risk_level.toUpperCase()}</span>
          <span class="intel-badge badge-type">${esc(a.type)}</span>
          <span class="intel-badge badge-${a.status === 'active' ? 'active' : 'disrupted'}">${a.status.toUpperCase()}</span>
          ${a.targeting_sea ? '<span class="intel-badge badge-sea">ğŸŒ SEA</span>' : ''}
        </div>
        ${a.aliases?.length ? `<div style="font-size:.71rem;color:var(--muted);margin-bottom:6px">Also known as: ${a.aliases.map(al => esc(al)).join(', ')}</div>` : ''}
        <div class="intel-desc">${esc(a.description)}</div>
        ${a.sectors?.length ? `<div style="font-size:.72rem;color:var(--muted);margin-bottom:6px">ğŸ¯ Sectors: ${a.sectors.map(s => esc(s)).join(', ')}</div>` : ''}
        <div class="intel-ttps">${(a.ttps||[]).map(t => `<span class="ttp-tag">${esc(t)}</span>`).join('')}</div>
        ${a.known_malware?.length ? `<div style="font-size:.71rem;color:var(--purple);margin:6px 0">ğŸ¦  Malware: ${a.known_malware.map(m => esc(m)).join(', ')}</div>` : ''}
        <div class="intel-hits">
          <span class="intel-hit-count ${a.hit_count > 0 ? 'has-hits' : ''}">${a.hit_count}</span>
          <span>keyword hits in database</span>
        </div>
        ${a.recent_hits?.length ? `<div style="margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:8px;max-height:120px;overflow-y:auto">
          ${a.recent_hits.map(h => `<div style="font-size:.72rem;padding:3px 0;border-bottom:1px solid var(--border)">
            <span style="color:var(--accent);font-family:var(--mono)">${esc(h.keyword)}</span>
            <span style="color:var(--muted);margin:0 6px">Â·</span>
            <span style="color:var(--muted)">${h.found_at ? new Date(h.found_at+'Z').toLocaleDateString() : 'â€”'}</span>
          </div>`).join('')}
        </div>` : ''}
      </div>
    `).join('');
  }

  // â”€â”€ Digest / Mailing List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSubscribers() {
    const el = document.getElementById('subscribersList');
    if (!el || !isAdmin) return;
    try {
      const data = await (await fetch('/api/digest/subscribers')).json();
      const subs = data.subscribers || [];
      if (!subs.length) {
        el.innerHTML = '<p style="color:var(--muted);font-size:.83rem">No subscribers yet. Add the first one above.</p>';
        return;
      }
      el.innerHTML = subs.map(s => `
        <div class="subscriber-row">
          <span style="font-family:var(--mono)">${esc(s)}</span>
          <button class="btn btn-secondary" style="font-size:.72rem;padding:3px 10px;color:var(--red);border-color:rgba(248,81,73,.3)" onclick="removeSubscriber('${esc(s)}')">Remove</button>
        </div>
      `).join('');
    } catch(e) { /* not admin */ }
  }

  async function addSubscriber() {
    const email = document.getElementById('newSubscriberEmail').value.trim();
    if (!email) return;
    const res = await fetch('/api/digest/subscribers', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({email}) });
    const d = await res.json();
    if (d.ok) { toast('Subscriber added'); document.getElementById('newSubscriberEmail').value = ''; loadSubscribers(); }
    else toast(d.error || 'Error', 'error');
  }

  async function removeSubscriber(email) {
    if (!confirm(`Remove ${email} from digest list?`)) return;
    await fetch('/api/digest/subscribers', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({email}) });
    toast('Removed');
    loadSubscribers();
  }

  async function sendDigestNow() {
    const btn = document.getElementById('digestSendBtn');
    btn.textContent = 'â³ Sendingâ€¦';
    btn.disabled = true;
    try {
      const res = await fetch('/api/digest/send', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({}) });
      const d = await res.json();
      if (d.ok) toast(`âœ… Sent to ${d.sent}/${d.total} subscribers`);
      else toast(d.error || `Failed â€” ${d.errors?.join(', ')}`, 'error');
    } catch(e) {
      toast('Network error', 'error');
    } finally {
      btn.textContent = 'â–¶ Send Now';
      btn.disabled = false;
    }
  }

  async function downloadDigest() {
    window.location.href = '/api/digest/preview';
  }

  // â”€â”€ DNS Crawler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let dnsPolling = null;

  async function loadDNSInvestigations() {
    showDNSHistory();
  }

  async function showDNSHistory() {
    const el = document.getElementById('dnsContent');
    el.innerHTML = '<div class="dns-running"><div class="dns-spinner"></div> Loading historyâ€¦</div>';
    try {
      const data = await (await fetch('/api/dns/investigations')).json();
      if (!data.length) {
        el.innerHTML = '<div class="empty"><div class="icon">ğŸŒ</div><p>No DNS investigations yet. Enter a domain above.</p></div>';
        return;
      }
      el.innerHTML = '<div class="dns-history">' + data.map(r => `
        <div class="dns-history-row" onclick="loadDNSResult(${r.id})">
          <div class="dns-history-domain">${esc(r.domain)}</div>
          ${r.zone_transfer_success ? '<span class="dns-badge-fail">âš  ZONE TRANSFER</span>' : ''}
          <span class="dns-history-meta">${r.subdomain_count ?? '?'} subdomains</span>
          <span class="dns-history-meta">${r.has_spf ? 'âœ“ SPF' : '<span style="color:var(--red)">âœ— SPF</span>'}</span>
          <span class="dns-history-meta">${r.has_dmarc ? 'âœ“ DMARC' : '<span style="color:var(--red)">âœ— DMARC</span>'}</span>
          <span class="dns-history-meta" style="color:var(--muted)">${fmtTime(r.created_at)}</span>
          <span class="dns-badge-${r.status === 'complete' ? 'ok' : r.status === 'running' ? 'warn' : 'fail'}">${r.status.toUpperCase()}</span>
          <button class="btn btn-secondary" style="font-size:.7rem;padding:3px 8px;color:var(--red)" onclick="event.stopPropagation();deleteDNS(${r.id})">âœ•</button>
        </div>`).join('') + '</div>';
    } catch(e) {
      el.innerHTML = '<div class="empty"><div class="icon">âš ï¸</div><p>Failed to load history.</p></div>';
    }
  }

  async function startDNS() {
    const domain = document.getElementById('dnsInput').value.trim();
    if (!domain) return;
    const btn = document.getElementById('dnsBtn');
    btn.disabled = true; btn.textContent = 'â³ Startingâ€¦';
    try {
      const res = await fetch('/api/dns/investigate', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({domain})
      });
      const d = await res.json();
      if (d.ok) {
        toast(`DNS recon started for ${domain}`);
        pollDNS(d.id);
      } else {
        toast(d.error || 'Error', 'error');
      }
    } catch(e) {
      toast('Network error', 'error');
    } finally {
      btn.disabled = false; btn.textContent = 'ğŸ” Investigate';
    }
  }

  function pollDNS(id) {
    if (dnsPolling) clearInterval(dnsPolling);
    const el = document.getElementById('dnsContent');
    el.innerHTML = `<div class="dns-running"><div class="dns-spinner"></div> Running DNS recon â€” querying records, crt.sh, zone transfer, geolocationâ€¦</div>`;
    dnsPolling = setInterval(async () => {
      try {
        const data = await (await fetch(`/api/dns/investigations/${id}`)).json();
        if (data.status === 'complete') {
          clearInterval(dnsPolling);
          renderDNSResult(data);
        } else if (data.status === 'error') {
          clearInterval(dnsPolling);
          el.innerHTML = `<div class="empty"><div class="icon">âš ï¸</div><p>Recon failed: ${esc(data.error || 'unknown error')}</p></div>`;
        }
      } catch(e) { clearInterval(dnsPolling); }
    }, 2500);
  }

  async function loadDNSResult(id) {
    const el = document.getElementById('dnsContent');
    el.innerHTML = '<div class="dns-running"><div class="dns-spinner"></div> Loadingâ€¦</div>';
    try {
      const data = await (await fetch(`/api/dns/investigations/${id}`)).json();
      if (data.status === 'running') { pollDNS(id); return; }
      renderDNSResult(data);
    } catch(e) {
      el.innerHTML = '<div class="empty"><div class="icon">âš ï¸</div><p>Failed to load result.</p></div>';
    }
  }

  function renderDNSResult(data) {
    const el = document.getElementById('dnsContent');
    const r = data.result || {};
    const dns = r.dns_records || {};
    const zt = r.zone_transfer || {};
    const email = r.email_security || {};
    const resolved = r.subdomains_resolved || [];
    const passive = r.subdomains_passive || [];
    const ipGeo = r.ip_geo || {};
    const ptr = r.ptr_records || {};
    const ztSuccess = Object.values(zt).some(v => v && v.success);

    let html = `<div class="dns-detail">`;

    // â”€â”€ Back button â”€â”€
    html += `<div style="margin-bottom:14px;display:flex;align-items:center;gap:10px">
      <button class="btn btn-secondary" onclick="showDNSHistory()">â† History</button>
      <span style="font-family:var(--mono);font-size:1rem;font-weight:700">${esc(data.domain)}</span>
      <span style="font-size:.75rem;color:var(--muted)">${fmtTime(data.created_at)}</span>
      <button class="btn btn-primary" style="margin-left:auto" onclick="exportDNSpdf(${data.id}, '${esc(data.domain)}')">â¬‡ Export PDF</button>
    </div>`;

    // â”€â”€ Summary cards â”€â”€
    const mainIPs = (dns.A || []).concat(dns.AAAA || []);
    html += `<div class="dns-summary-cards">
      <div class="dns-summary-card"><div class="dns-summary-num">${data.subdomain_count ?? 0}</div><div class="dns-summary-label">Subdomains Found</div></div>
      <div class="dns-summary-card"><div class="dns-summary-num">${data.resolved_count ?? 0}</div><div class="dns-summary-label">Resolved</div></div>
      <div class="dns-summary-card"><div class="dns-summary-num">${mainIPs.length}</div><div class="dns-summary-label">IP Addresses</div></div>
      <div class="dns-summary-card"><div class="dns-summary-num ${ztSuccess ? 'dns-badge-fail' : ''}">${ztSuccess ? 'âš  YES' : 'No'}</div><div class="dns-summary-label">Zone Transfer</div></div>
      <div class="dns-summary-card"><div class="dns-summary-num ${email.spf_valid ? 'dns-badge-ok' : 'dns-badge-fail'}">${email.spf_valid ? 'âœ“' : 'âœ—'}</div><div class="dns-summary-label">SPF</div></div>
      <div class="dns-summary-card"><div class="dns-summary-num ${email.dmarc_valid ? 'dns-badge-ok' : 'dns-badge-fail'}">${email.dmarc_valid ? 'âœ“' : 'âœ—'}</div><div class="dns-summary-label">DMARC</div></div>
    </div>`;

    // â”€â”€ Zone transfer warning â”€â”€
    if (ztSuccess) {
      const ns = Object.entries(zt).filter(([,v]) => v.success).map(([k]) => k).join(', ');
      html += `<div class="dns-zt-success">âš  ZONE TRANSFER SUCCEEDED on ${esc(ns)} â€” full zone data exposed. This is a critical misconfiguration.</div><br/>`;
    }

    // â”€â”€ Email security issues â”€â”€
    const issues = email.issues || [];
    if (issues.length) {
      html += dnsSection('âš  Email Security Issues', issues.map(i =>
        `<div style="padding:5px 0;color:var(--yellow);font-size:.82rem">â€¢ ${esc(i)}</div>`
      ).join(''));
    }

    // â”€â”€ DNS Records â”€â”€
    const recTypes = ['A','AAAA','MX','NS','TXT','CNAME','SOA','CAA'];
    let recRows = '';
    for (const type of recTypes) {
      if (!dns[type]) continue;
      for (const val of dns[type]) {
        const geo = (type === 'A' || type === 'AAAA') ? ipGeo[val] : null;
        const geoStr = geo ? ` <span style="color:var(--muted);font-size:.7rem">(${geo.city || ''} ${geo.country || ''} Â· ${geo.org || ''})</span>` : '';
        const ptrStr = ptr[val] ? ` <span style="color:var(--muted);font-size:.7rem">â†’ ${esc(ptr[val])}</span>` : '';
        recRows += `<tr><td><span class="badge badge-active" style="font-size:.65rem">${type}</span></td><td style="font-family:var(--mono)">${esc(val)}${ptrStr}${geoStr}</td></tr>`;
      }
    }
    if (recRows) {
      html += dnsSection('ğŸ“‹ DNS Records',
        `<table class="dns-record-table"><thead><tr><th>Type</th><th>Value</th></tr></thead><tbody>${recRows}</tbody></table>`
      );
    }

    // â”€â”€ Email security detail â”€â”€
    let emailRows = '';
    if (email.spf) emailRows += `<tr><td>SPF</td><td style="font-family:var(--mono);font-size:.72rem">${esc(email.spf)}</td></tr>`;
    if (email.dmarc) emailRows += `<tr><td>DMARC</td><td style="font-family:var(--mono);font-size:.72rem">${esc(email.dmarc)}</td></tr>`;
    if (email.dkim_selectors_found?.length) {
      emailRows += `<tr><td>DKIM</td><td>Selectors found: ${email.dkim_selectors_found.map(s => `<code>${esc(s)}</code>`).join(', ')}</td></tr>`;
    }
    if (emailRows) {
      html += dnsSection('ğŸ“§ Email Security',
        `<table class="dns-record-table"><thead><tr><th>Record</th><th>Value</th></tr></thead><tbody>${emailRows}</tbody></table>`
      );
    }

    // â”€â”€ Zone transfer detail â”€â”€
    if (ztSuccess) {
      for (const [ns, info] of Object.entries(zt)) {
        if (!info.success) continue;
        const rows = (info.records || []).slice(0, 100).map(rec =>
          `<tr><td>${esc(rec.name)}</td><td><span class="badge badge-active" style="font-size:.65rem">${esc(rec.type)}</span></td><td style="font-family:var(--mono);font-size:.72rem">${esc(rec.value)}</td></tr>`
        ).join('');
        html += dnsSection(`ğŸš¨ Zone Transfer â€” ${esc(ns)} (${info.record_count} records)`,
          `<table class="dns-record-table"><thead><tr><th>Name</th><th>Type</th><th>Value</th></tr></thead><tbody>${rows}</tbody></table>`
        );
      }
    }

    // â”€â”€ Subdomains resolved â”€â”€
    if (resolved.length) {
      const subRows = resolved.map(s => {
        const ips = s.ips.join(', ');
        const geo = (s.geo || []).filter(g => g && g.country).map(g =>
          `${g.city || ''} ${g.countryCode || ''}`).join(' / ');
        return `<tr><td style="font-family:var(--mono)">${esc(s.subdomain)}</td><td style="font-family:var(--mono)">${esc(ips)}</td><td>${esc(geo)}</td></tr>`;
      }).join('');
      html += dnsSection(`ğŸ” Resolved Subdomains (${resolved.length})`,
        `<table class="dns-record-table"><thead><tr><th>Subdomain</th><th>IP(s)</th><th>Location</th></tr></thead><tbody>${subRows}</tbody></table>`
      );
    }

    // â”€â”€ Certificate transparency â”€â”€
    if (passive.length) {
      const certRows = passive.slice(0, 100).map(c =>
        `<tr><td style="font-family:var(--mono)">${esc(c.subdomain)}</td><td style="font-size:.72rem;color:var(--muted)">${esc((c.issuer||'').split('O=')[1]?.split(',')[0] || c.issuer || '')}</td><td style="font-size:.72rem;color:var(--muted)">${(c.not_after||'').substring(0,10)}</td></tr>`
      ).join('');
      html += dnsSection(`ğŸ” Certificate Transparency â€” crt.sh (${passive.length} certs)`,
        `<table class="dns-record-table"><thead><tr><th>Subdomain</th><th>Issuer</th><th>Expires</th></tr></thead><tbody>${certRows}</tbody></table>`
      );
    }

    // â”€â”€ Errors â”€â”€
    if (r.errors?.length) {
      html += dnsSection('â„¹ï¸ Notes',
        r.errors.map(e => `<div style="font-size:.78rem;color:var(--muted);padding:3px 0">â€¢ ${esc(e)}</div>`).join('')
      );
    }

    html += `</div>`;
    el.innerHTML = html;
  }

  function dnsSection(title, body) {
    const id = 'dss' + Math.random().toString(36).slice(2,8);
    return `<div class="dns-section">
      <div class="dns-section-hdr" onclick="toggleDNSSection('${id}')">
        <span class="dns-section-title">${title}</span>
        <span id="arr${id}" style="color:var(--muted);font-size:.8rem">â–¾</span>
      </div>
      <div class="dns-section-body" id="${id}">${body}</div>
    </div>`;
  }

  function toggleDNSSection(id) {
    const el = document.getElementById(id);
    const arr = document.getElementById('arr' + id);
    const open = el.style.display !== 'none';
    el.style.display = open ? 'none' : 'block';
    arr.textContent = open ? 'â–¸' : 'â–¾';
  }

  function exportDNSpdf(id, domain) {
    toast(`Generating PDF for ${domain}â€¦`);
    window.location.href = `/api/dns/investigations/${id}/pdf`;
  }

  async function deleteDNS(id) {
    if (!confirm('Delete this DNS investigation?')) return;
    await fetch(`/api/dns/investigations/${id}`, {method:'DELETE'});
    toast('Deleted');
    showDNSHistory();
  }

</script>
</body>
</html>
